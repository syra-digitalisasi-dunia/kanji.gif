<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aksara Jepang Interaktif</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Universal box-sizing for consistency */
        *, *::before, *::after {
            box-sizing: border-box;
        }
        /* Custom styles for the canvas to ensure it's responsive and centered */
        canvas {
            background-color: #f9fafb; /* Light gray background for canvas */
            display: block;
            width: 100%;
            height: 100%;
            border-radius: 0.375rem; /* rounded-md */
        }
        /* Ensure font Inter is used */
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            /* height: 100vh; */ /* Removed to allow content to dictate height for scrolling */
            /* overflow: hidden; */ /* Removed to allow body to scroll */
        }
        html {
            height: 100%; /* Ensure html also takes full height */
        }

        /* Style for the feedback message */
        #feedback-message.success {
            color: #10B981; /* green-500 */
        }
        #feedback-message.warning {
            color: #F59E0B; /* orange-500 */
        }
        #feedback-message.error {
            color: #EF4444; /* red-500 */
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-100 to-purple-100 font-sans text-gray-800 p-2 sm:p-4 flex flex-col items-center overflow-y-auto">

    <!-- Header Aplikasi -->
    <header class="w-full max-w-2xl text-center mb-1 sm:mb-4 flex-shrink-0">
        <h1 class="text-2xl sm:text-4xl font-extrabold text-blue-700 mb-1 sm:mb-2">Aksara Jepang Interaktif</h1>
        <p class="text-sm sm:text-lg text-gray-600">Latih goresan Hiragana, Katakana, dan Kanji Anda!</p>
    </header>

    <!-- Navigasi Script -->
    <nav class="mb-2 sm:mb-6 flex space-x-2 sm:space-x-4 bg-white p-1 sm:p-2 rounded-full shadow-lg flex-shrink-0">
        <button id="hiragana-btn" class="px-3 py-1 sm:px-6 sm:py-3 rounded-full font-semibold text-sm sm:text-base transition duration-300 ease-in-out bg-blue-600 text-white shadow-md">
            Hiragana
        </button>
        <button id="katakana-btn" class="px-3 py-1 sm:px-6 sm:py-3 rounded-full font-semibold text-sm sm:text-base transition duration-300 ease-in-out bg-gray-200 text-gray-700 hover:bg-blue-100">
            Katakana
        </button>
        <button id="kanji-btn" class="px-3 py-1 sm:px-6 sm:py-3 rounded-full font-semibold text-sm sm:text-base transition duration-300 ease-in-out bg-gray-200 text-gray-700 hover:bg-blue-100">
            Kanji
        </button>
    </nav>

    <!-- Area Latihan - Now this main element will be scrollable -->
    <main class="w-full sm:max-w-xl md:max-w-2xl lg:max-w-3xl px-2 sm:px-4 flex flex-col items-center flex-grow min-h-0">
        <div class="flex flex-col items-center p-2 sm:p-4 bg-white rounded-lg shadow-md w-full mx-auto">
            <!-- Display GIF -->
            <div class="mb-1 sm:mb-4 w-24 h-24 sm:w-32 sm:h-32 flex-shrink-0 flex items-center justify-center bg-gray-100 rounded-md overflow-hidden">
                <img id="character-gif" src="" alt="Stroke order GIF" class="w-full h-full object-contain"
                     onerror="this.onerror=null;this.src='https://placehold.co/150x150/e0e0e0/000000?text=GIF+Tidak+Ada';">
            </div>

            <!-- Romaji display -->
            <div id="romaji-display" class="text-base sm:text-xl text-gray-600 mb-0.5 sm:mb-2 flex-shrink-0"></div>
            
            <div id="meaning-display" class="text-sm sm:text-lg text-gray-700 mb-1 sm:mb-4 flex-shrink-0"></div>
            <div id="stroke-order-display" class="text-xs sm:text-sm text-gray-500 mb-1 sm:mb-4 p-1 sm:p-2 bg-gray-50 rounded-md w-full flex-shrink-0">
                <h4 class="font-semibold mb-0 sm:mb-1">Urutan Goresan:</h4>
                <pre id="stroke-order-text" class="whitespace-pre-wrap"></pre>
            </div>
            
            <!-- Canvas container - this should be the flex-grow element that takes remaining space -->
            <div class="relative w-full aspect-square border-2 border-gray-300 rounded-md overflow-hidden bg-gray-50 flex-grow min-h-0">
                <canvas id="writingCanvas"></canvas>
                <!-- Garis bantu untuk kanvas -->
                <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                    <div class="absolute w-full h-px bg-gray-300 transform -translate-y-1/2"></div>
                    <div class="absolute h-full w-px bg-gray-300 transform -translate-x-1/2"></div>
                </div>
            </div>
            <button id="clear-btn" class="mt-1 sm:mt-4 px-4 py-1 sm:px-6 sm:py-2 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 transition duration-300 ease-in-out text-sm sm:text-base flex-shrink-0">
                Hapus
            </button>
            <button id="check-btn" class="mt-0.5 sm:mt-2 px-4 py-1 sm:px-6 sm:py-2 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition duration-300 ease-in-out text-sm sm:text-base flex-shrink-0">
                Periksa Tulisan
            </button>
            <div id="feedback-message" class="mt-1 sm:mt-4 text-center text-xs sm:text-sm flex-shrink-0"></div>
        </div>
    </main>

    <!-- Navigasi Karakter -->
    <div class="mt-2 sm:mt-6 flex space-x-2 sm:space-x-4 items-center flex-shrink-0">
        <button id="prev-btn" class="px-4 py-2 sm:px-6 sm:py-3 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 transition duration-300 ease-in-out flex items-center justify-center text-sm sm:text-base">
            <svg class="w-4 h-4 sm:w-5 sm:h-5 mr-1 sm:mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            Sebelumnya
        </button>
        <span id="progress-display" class="text-base sm:text-lg font-semibold text-gray-700"></span>
        <button id="next-btn" class="px-4 py-2 sm:px-6 sm:py-3 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 transition duration-300 ease-in-out flex items-center justify-center text-sm sm:text-base">
            Berikutnya
            <svg class="w-4 h-4 sm:w-5 sm:h-5 ml-1 sm:ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
        </button>
    </div>

    <script>
        // Helper function to generate GIF URLs from the GitHub repository
        const getGifUrl = (scriptType, char) => {
            const encodedChar = encodeURIComponent(char);
            // Using raw.githubusercontent.com for direct access to files
            return `https://raw.githubusercontent.com/syra-digitalisasi-dunia/kanji.gif/master/${scriptType}/gif/150x150/${encodedChar}.gif`;
        };

        // Data karakter Hiragana (All basic 46)
        const hiraganaCharacters = [
            { char: 'あ', romaji: 'a', strokeOrder: '1. Kiri atas ke kanan bawah\\n2. Melengkung ke kanan bawah\\n3. Lingkaran kecil di tengah', gifUrl: getGifUrl('hiragana', 'あ') },
            { char: 'い', romaji: 'i', strokeOrder: '1. Kiri atas ke kanan bawah\\n2. Sedikit melengkung ke kanan', gifUrl: getGifUrl('hiragana', 'い') },
            { char: 'う', romaji: 'u', strokeOrder: '1. Garis pendek horizontal\\n2. Melengkung ke bawah', gifUrl: getGifUrl('hiragana', 'う') },
            { char: 'え', romaji: 'e', strokeOrder: '1. Garis horizontal\\n2. Garis vertikal melengkung\\n3. Garis pendek horizontal', gifUrl: getGifUrl('hiragana', 'え') },
            { char: 'お', romaji: 'o', strokeOrder: '1. Garis horizontal\\n2. Garis vertikal melengkung\\n3. Lingkaran kecil di kanan', gifUrl: getGifUrl('hiragana', 'お') },
            { char: 'か', romaji: 'ka', strokeOrder: '1. Garis horizontal ke kanan\\n2. Garis vertikal ke bawah\\n3. Garis miring ke kanan bawah', gifUrl: getGifUrl('hiragana', 'か') },
            { char: 'き', romaji: 'ki', strokeOrder: '1. Garis horizontal\\n2. Garis horizontal\\n3. Garis horizontal\\n4. Garis miring ke kanan bawah', gifUrl: getGifUrl('hiragana', 'き') },
            { char: 'く', romaji: 'ku', strokeOrder: '1. Garis melengkung ke kanan bawah', gifUrl: getGifUrl('hiragana', 'く') },
            { char: 'け', romaji: 'ke', strokeOrder: '1. Garis horizontal\\n2. Garis vertikal ke bawah\\n3. Garis miring ke kanan bawah', gifUrl: getGifUrl('hiragana', 'け') },
            { char: 'こ', romaji: 'ko', strokeOrder: '1. Garis horizontal\\n2. Garis horizontal di bawahnya', gifUrl: getGifUrl('hiragana', 'こ') },
            { char: 'さ', romaji: 'sa', strokeOrder: '1. Garis horizontal\\n2. Garis vertikal melengkung\\n3. Garis miring ke kanan bawah', gifUrl: getGifUrl('hiragana', 'さ') },
            { char: 'し', romaji: 'shi', strokeOrder: '1. Garis melengkung ke bawah', gifUrl: getGifUrl('hiragana', 'し') },
            { char: 'す', romaji: 'su', strokeOrder: '1. Garis horizontal\\n2. Garis vertikal melengkung\\n3. Lingkaran kecil di tengah', gifUrl: getGifUrl('hiragana', 'す') },
            { char: 'せ', romaji: 'se', strokeOrder: '1. Garis horizontal\\n2. Garis vertikal melengkung', gifUrl: getGifUrl('hiragana', 'せ') },
            { char: 'そ', romaji: 'so', strokeOrder: '1. Garis melengkung ke bawah', gifUrl: getGifUrl('hiragana', 'そ') },
            { char: 'た', romaji: 'ta', strokeOrder: '1. Garis horizontal\\n2. Garis vertikal\\n3. Garis horizontal\\n4. Garis miring ke kanan bawah', gifUrl: getGifUrl('hiragana', 'た') },
            { char: 'ち', romaji: 'chi', strokeOrder: '1. Garis horizontal\\n2. Garis vertikal melengkung', gifUrl: getGifUrl('hiragana', 'ち') },
            { char: 'つ', romaji: 'tsu', strokeOrder: '1. Garis melengkung ke kanan bawah', gifUrl: getGifUrl('hiragana', 'つ') },
            { char: 'て', romaji: 'te', strokeOrder: '1. Garis melengkung ke bawah', gifUrl: getGifUrl('hiragana', 'て') },
            { char: 'と', romaji: 'to', strokeOrder: '1. Garis pendek\\n2. Garis melengkung ke bawah', gifUrl: getGifUrl('hiragana', 'と') },
            { char: 'な', romaji: 'na', strokeOrder: '1. Garis horizontal\\n2. Garis vertikal\\n3. Garis pendek\\n4. Garis melengkung ke bawah', gifUrl: getGifUrl('hiragana', 'な') },
            { char: 'に', romaji: 'ni', strokeOrder: '1. Garis horizontal\\n2. Garis vertikal melengkung', gifUrl: getGifUrl('hiragana', 'に') },
            { char: 'ぬ', romaji: 'nu', strokeOrder: '1. Garis horizontal\\n2. Garis melengkung ke bawah\\n3. Lingkaran kecil', gifUrl: getGifUrl('hiragana', 'ぬ') },
            { char: 'ね', romaji: 'ne', strokeOrder: '1. Garis horizontal\\n2. Garis vertikal melengkung\\n3. Lingkaran kecil', gifUrl: getGifUrl('hiragana', 'ね') },
            { char: 'の', romaji: 'no', strokeOrder: '1. Garis melengkung ke bawah', gifUrl: getGifUrl('hiragana', 'の') },
            { char: 'は', romaji: 'ha', strokeOrder: '1. Garis vertikal\\n2. Garis horizontal\\n3. Garis melengkung ke bawah', gifUrl: getGifUrl('hiragana', 'は') },
            { char: 'ひ', romaji: 'hi', strokeOrder: '1. Garis melengkung ke bawah', gifUrl: getGifUrl('hiragana', 'ひ') },
            { char: 'ふ', romaji: 'fu', strokeOrder: '1. Garis horizontal\\n2. Garis melengkung ke bawah', gifUrl: getGifUrl('hiragana', 'ふ') },
            { char: 'へ', romaji: 'he', strokeOrder: '1. Garis melengkung ke bawah', gifUrl: getGifUrl('hiragana', 'へ') },
            { char: 'ほ', romaji: 'ho', strokeOrder: '1. Garis vertikal\\n2. Garis horizontal\\n3. Garis horizontal\\n4. Garis melengkung ke bawah', gifUrl: getGifUrl('hiragana', 'ほ') },
            { char: 'ま', romaji: 'ma', strokeOrder: '1. Garis horizontal\\n2. Garis vertikal\\n3. Garis melengkung ke bawah', gifUrl: getGifUrl('hiragana', 'ま') },
            { char: 'み', romaji: 'mi', strokeOrder: '1. Garis vertikal melengkung\\n2. Garis vertikal melengkung', gifUrl: getGifUrl('hiragana', 'み') },
            { char: 'む', romaji: 'mu', strokeOrder: '1. Garis horizontal\\n2. Garis vertikal melengkung\\n3. Lingkaran kecil', gifUrl: getGifUrl('hiragana', 'む') },
            { char: 'め', romaji: 'me', strokeOrder: '1. Garis horizontal\\n2. Garis vertikal melengkung\\n3. Lingkaran kecil', gifUrl: getGifUrl('hiragana', 'め') },
            { char: 'も', romaji: 'mo', strokeOrder: '1. Garis horizontal\\n2. Garis horizontal\\n3. Garis vertikal melengkung\\n4. Lingkaran kecil', gifUrl: getGifUrl('hiragana', 'も') },
            { char: 'や', romaji: 'ya', strokeOrder: '1. Garis melengkung ke bawah\\n2. Garis melengkung ke bawah\\n3. Garis vertikal', gifUrl: getGifUrl('hiragana', 'या') },
            { char: 'ゆ', romaji: 'yu', strokeOrder: '1. Garis melengkung ke bawah\\n2. Garis vertikal melengkung', gifUrl: getGifUrl('hiragana', 'ゆ') },
            { char: 'よ', romaji: 'yo', strokeOrder: '1. Garis horizontal\\n2. Garis vertikal melengkung', gifUrl: getGifUrl('hiragana', 'よ') },
            { char: 'ら', romaji: 'ra', strokeOrder: '1. Garis horizontal\\n2. Garis vertikal melengkung', gifUrl: getGifUrl('hiragana', 'ら') },
            { char: 'り', romaji: 'ri', strokeOrder: '1. Mulai dari kiri atas, tarik garis melengkung ke bawah dan ke kanan.\\n2. Mulai dari tengah kanan, tarik garis pendek melengkung ke bawah dan sedikit ke kiri.', gifUrl: getGifUrl('hiragana', 'り') },
            { char: 'る', romaji: 'ru', strokeOrder: '1. Garis melengkung ke bawah', gifUrl: getGifUrl('hiragana', 'る') },
            { char: 'れ', romaji: 're', strokeOrder: '1. Garis horizontal\\n2. Garis vertikal melengkung', gifUrl: getGifUrl('hiragana', 'れ') },
            { char: 'ろ', romaji: 'ro', strokeOrder: '1. Garis melengkung ke bawah', gifUrl: getGifUrl('hiragana', 'ろ') },
            { char: 'わ', romaji: 'wa', strokeOrder: '1. Garis horizontal\\n2. Garis vertikal melengkung', gifUrl: getGifUrl('hiragana', 'わ') },
            { char: 'を', romaji: 'wo', strokeOrder: '1. Garis horizontal\\n2. Garis vertikal\\n3. Garis melengkung ke bawah', gifUrl: getGifUrl('hiragana', 'を') },
            { char: 'ん', romaji: 'n', strokeOrder: '1. Garis melengkung ke bawah', gifUrl: getGifUrl('hiragana', 'ん') },
        ];

        // Data karakter Katakana (All basic 46)
        const katakanaCharacters = [
            { char: 'ア', romaji: 'a', strokeOrder: '1. Garis horizontal\\n2. Garis vertikal melengkung\\n3. Garis miring ke kanan bawah', gifUrl: getGifUrl('katakana', 'ア') },
            { char: 'イ', romaji: 'i', strokeOrder: '1. Garis miring ke kanan bawah\\n2. Garis miring ke kanan bawah', gifUrl: getGifUrl('katakana', 'イ') },
            { char: 'ウ', romaji: 'u', strokeOrder: '1. Garis pendek horizontal\\n2. Garis melengkung ke bawah\\n3. Garis pendek di kanan', gifUrl: getGifUrl('katakana', 'ウ') },
            { char: 'エ', romaji: 'e', strokeOrder: '1. Garis horizontal\\n2. Garis vertikal melengkung\\n3. Garis horizontal', gifUrl: getGifUrl('katakana', 'エ') },
            { char: 'オ', romaji: 'o', strokeOrder: '1. Garis horizontal\\n2. Garis vertikal melengkung\\n3. Garis pendek di kanan', gifUrl: getGifUrl('katakana', 'オ') },
            { char: 'カ', romaji: 'ka', strokeOrder: '1. Garis horizontal\\n2. Garis vertikal ke bawah\\n3. Garis miring ke kanan bawah', gifUrl: getGifUrl('katakana', 'カ') },
            { char: 'キ', romaji: 'ki', strokeOrder: '1. Garis horizontal\\n2. Garis horizontal\\n3. Garis miring ke kanan bawah', gifUrl: getGifUrl('katakana', 'キ') },
            { char: 'ク', romaji: 'ku', strokeOrder: '1. Garis melengkung ke kanan bawah', gifUrl: getGifUrl('katakana', 'ク') },
            { char: 'ケ', romaji: 'ke', strokeOrder: '1. Garis horizontal\\n2. Garis vertikal ke bawah\\n3. Garis miring ke kanan bawah', gifUrl: getGifUrl('katakana', 'ケ') },
            { char: 'コ', romaji: 'ko', strokeOrder: '1. Garis horizontal\\n2. Garis vertikal ke bawah\\n3. Garis horizontal', gifUrl: getGifUrl('katakana', 'コ') },
            { char: 'サ', romaji: 'sa', strokeOrder: '1. Garis horizontal\\n2. Garis vertikal melengkung\\n3. Garis miring ke kanan bawah', gifUrl: getGifUrl('katakana', 'サ') },
            { char: 'シ', romaji: 'shi', strokeOrder: '1. Garis melengkung ke bawah', gifUrl: getGifUrl('katakana', 'シ') },
            { char: 'ス', romaji: 'su', strokeOrder: '1. Garis horizontal\\n2. Garis vertikal melengkung\\n3. Garis melengkung ke bawah', gifUrl: getGifUrl('katakana', 'स्') },
            { char: 'セ', romaji: 'se', strokeOrder: '1. Garis horizontal\\n2. Garis vertikal melengkung', gifUrl: getGifUrl('katakana', 'से') },
            { char: 'ソ', romaji: 'so', strokeOrder: '1. Garis melengkung ke bawah', gifUrl: getGifUrl('katakana', 'सो') },
            { char: 'タ', romaji: 'ta', strokeOrder: '1. Garis horizontal\\n2. Garis vertikal\\n3. Garis horizontal\\n4. Garis miring ke kanan bawah', gifUrl: getGifUrl('katakana', 'ता') },
            { char: 'チ', romaji: 'chi', strokeOrder: '1. Garis horizontal\\n2. Garis vertikal melengkung', gifUrl: getGifUrl('katakana', 'चि') },
            { char: 'ツ', romaji: 'tsu', strokeOrder: '1. Garis melengkung ke kanan bawah', gifUrl: getGifUrl('katakana', 'त्सु') },
            { char: 'テ', romaji: 'te', strokeOrder: '1. Garis melengkung ke bawah', gifUrl: getGifUrl('katakana', 'ते') },
            { char: 'ト', romaji: 'to', strokeOrder: '1. Garis pendek\\n2. Garis melengkung ke bawah', gifUrl: getGifUrl('katakana', 'तो') },
            { char: 'ナ', romaji: 'na', strokeOrder: '1. Garis horizontal\\n2. Garis vertikal\\n3. Garis pendek\\n4. Garis melengkung ke bawah', gifUrl: getGifUrl('katakana', 'ना') },
            { char: 'ニ', romaji: 'ni', strokeOrder: '1. Garis horizontal\\n2. Garis vertikal melengkung', gifUrl: getGifUrl('katakana', 'नि') },
            { char: 'ヌ', romaji: 'nu', strokeOrder: '1. Garis horizontal\\n2. Garis melengkung ke bawah\\n3. Garis pendek', gifUrl: getGifUrl('katakana', 'नु') },
            { char: 'ネ', romaji: 'ne', strokeOrder: '1. Garis horizontal\\n2. Garis vertikal melengkung\\n3. Garis pendek', gifUrl: getGifUrl('katakana', 'ने') },
            { char: 'ノ', romaji: 'no', strokeOrder: '1. Garis melengkung ke bawah', gifUrl: getGifUrl('katakana', 'नो') },
            { char: 'ハ', romaji: 'ha', strokeOrder: '1. Garis vertikal\\n2. Garis horizontal\\n3. Garis melengkung ke bawah', gifUrl: getGifUrl('katakana', 'हा') },
            { char: 'ヒ', romaji: 'hi', strokeOrder: '1. Garis melengkung ke bawah', gifUrl: getGifUrl('katakana', 'हि') },
            { char: 'フ', romaji: 'fu', strokeOrder: '1. Garis horizontal\\n2. Garis melengkung ke bawah', gifUrl: getGifUrl('katakana', 'फु') },
            { char: 'ヘ', romaji: 'he', strokeOrder: '1. Garis melengkung ke bawah', gifUrl: getGifUrl('katakana', 'हे') },
            { char: 'ホ', romaji: 'ho', strokeOrder: '1. Garis vertikal\\n2. Garis horizontal\\n3. Garis horizontal\\n4. Garis melengkung ke bawah', gifUrl: getGifUrl('katakana', 'हो') },
            { char: 'マ', romaji: 'ma', strokeOrder: '1. Garis horizontal\\n2. Garis vertikal\\n3. Garis melengkung ke bawah', gifUrl: getGifUrl('katakana', 'मा') },
            { char: 'ミ', romaji: 'mi', strokeOrder: '1. Garis vertikal melengkung\\n2. Garis vertikal melengkung', gifUrl: getGifUrl('katakana', 'मि') },
            { char: 'ム', romaji: 'mu', strokeOrder: '1. Garis horizontal\\n2. Garis vertikal melengkung\\n3. Garis pendek', gifUrl: getGifUrl('katakana', 'मु') },
            { char: 'メ', romaji: 'me', strokeOrder: '1. Garis horizontal\\n2. Garis vertikal melengkung\\n3. Garis pendek', gifUrl: getGifUrl('katakana', 'मे') },
            { char: 'モ', romaji: 'mo', strokeOrder: '1. Garis horizontal\\n2. Garis horizontal\\n3. Garis vertikal melengkung\\n4. Garis pendek', gifUrl: getGifUrl('katakana', 'मो') },
            { char: 'ヤ', romaji: 'ya', strokeOrder: '1. Garis melengkung ke bawah\\n2. Garis melengkung ke bawah\\n3. Garis vertikal', gifUrl: getGifUrl('katakana', 'या') },
            { char: 'ユ', romaji: 'yu', strokeOrder: '1. Garis melengkung ke bawah\\n2. Garis vertikal melengkung', gifUrl: getGifUrl('katakana', 'यु') },
            { char: 'ヨ', romaji: 'yo', strokeOrder: '1. Garis horizontal\\n2. Garis vertikal melengkung', gifUrl: getGifUrl('katakana', 'यो') },
            { char: 'ラ', romaji: 'ra', strokeOrder: '1. Garis horizontal\\n2. Garis vertikal melengkung', gifUrl: getGifUrl('katakana', 'रा') },
            { char: 'リ', romaji: 'ri', strokeOrder: '1. Garis vertikal melengkung\\n2. Garis vertikal melengkung', gifUrl: getGifUrl('katakana', 'रि') },
            { char: 'ル', romaji: 'ru', strokeOrder: '1. Garis melengkung ke bawah', gifUrl: getGifUrl('katakana', 'रु') },
            { char: 'レ', romaji: 're', strokeOrder: '1. Garis horizontal\\n2. Garis vertikal melengkung', gifUrl: getGifUrl('katakana', 'रे') },
            { char: 'ロ', romaji: 'ro', strokeOrder: '1. Garis melengkung ke bawah', gifUrl: getGifUrl('katakana', 'रो') },
            { char: 'ワ', romaji: 'wa', strokeOrder: '1. Garis horizontal\\n2. Garis vertikal melengkung', gifUrl: getGifUrl('katakana', 'वा') },
            { char: 'ヲ', romaji: 'wo', strokeOrder: '1. Garis horizontal\\n2. Garis vertikal\\n3. Garis melengkung ke bawah', gifUrl: getGifUrl('katakana', 'ヲ') },
            { char: 'ン', romaji: 'n', strokeOrder: '1. Garis melengkung ke bawah', gifUrl: getGifUrl('katakana', 'न') },
        ];

        // Data karakter Kanji (Expanded sample)
        const kanjiCharacters = [
            { char: '日', romaji: 'nichi, hi', meaning: 'Matahari, Hari', strokeOrder: '1. Garis vertikal\\n2. Garis horizontal\\n3. Garis horizontal\\n4. Garis horizontal', gifUrl: getGifUrl('kanji', '日') },
            { char: '月', romaji: 'getsu, tsuki', meaning: 'Bulan', strokeOrder: '1. Garis vertikal\\n2. Garis horizontal\\n3. Garis horizontal\\n4. Garis vertikal', gifUrl: getGifUrl('kanji', '月') },
            { char: '山', romaji: 'san, yama', meaning: 'Gunung', strokeOrder: '1. Garis vertikal\\n2. Garis vertikal\\n3. Garis vertikal', gifUrl: getGifUrl('kanji', '山') },
            { char: '川', romaji: 'sen, kawa', meaning: 'Sungai', strokeOrder: '1. Garis vertikal\\n2. Garis vertikal\\n3. Garis vertikal', gifUrl: getGifUrl('kanji', '川') },
            { char: '人', romaji: 'jin, hito', meaning: 'Orang', strokeOrder: '1. Garis miring ke kiri\\n2. Garis miring ke kanan', gifUrl: getGifUrl('kanji', '人') },
            { char: '木', romaji: 'boku, ki', meaning: 'Pohon', strokeOrder: '1. Garis horizontal\\n2. Garis vertikal\\n3. Garis miring ke kiri\\n4. Garis miring ke kanan', gifUrl: getGifUrl('kanji', '木') },
            { char: '本', romaji: 'hon, moto', meaning: 'Buku, Asal', strokeOrder: '1. Garis horizontal\\n2. Garis vertikal\\n3. Garis horizontal\\n4. Garis miring ke kiri\\n5. Garis miring ke kanan', gifUrl: getGifUrl('kanji', '本') },
            { char: '大', romaji: 'dai, oo', meaning: 'Besar', strokeOrder: '1. Garis horizontal\\n2. Garis miring ke kiri\\n3. Garis miring ke kanan', gifUrl: getGifUrl('kanji', '大') },
            { char: '学', romaji: 'gaku, mana(bu)', meaning: 'Belajar', strokeOrder: '1. Garis miring ke kanan\\n2. Garis miring ke kiri\\n3. Garis horizontal\\n4. Garis vertikal\\n5. Garis horizontal\\n6. Garis miring ke kiri\\n7. Garis miring ke kanan\\n8. Garis miring ke kiri', gifUrl: getGifUrl('kanji', '学') },
            { char: '校', romaji: 'kou', meaning: 'Sekolah', strokeOrder: '1. Garis horizontal\\n2. Garis vertikal\\n3. Garis horizontal\\n4. Garis miring ke kiri\\n5. Garis miring ke kanan\\n6. Garis horizontal\\n7. Garis vertikal\\n8. Garis horizontal\\n9. Garis vertikal\\n10. Garis horizontal', gifUrl: getGifUrl('kanji', '校') },
            { char: '水', romaji: 'sui, mizu', meaning: 'Air', strokeOrder: '1. Garis vertikal\\n2. Garis vertikal\\n3. Garis vertikal', gifUrl: getGifUrl('kanji', '水') },
            { char: '火', romaji: 'ka, hi', meaning: 'Api', strokeOrder: '1. Garis miring ke kiri\\n2. Garis miring ke kanan\\n3. Garis miring ke kiri\\n4. Garis miring ke kanan', gifUrl: getGifUrl('kanji', '火') },
            { char: '土', romaji: 'do, tsuchi', meaning: 'Tanah', strokeOrder: '1. Garis horizontal\\n2. Garis vertikal\\n3. Garis horizontal', gifUrl: getGifUrl('kanji', '土') },
            { char: '金', romaji: 'kin, kane', meaning: 'Emas, Uang', strokeOrder: '1. Garis miring ke kiri\\n2. Garis miring ke kanan\\n3. Garis horizontal\\n4. Garis vertikal\\n5. Garis horizontal\\n6. Garis vertikal\\n7. Garis miring ke kiri\\n8. Garis miring ke kanan', gifUrl: getGifUrl('kanji', '金') },
            { char: '語', romaji: 'go', meaning: 'Bahasa', strokeOrder: '1. Garis vertikal\\n2. Garis horizontal\\n3. Garis horizontal\\n4. Garis vertikal\\n5. Garis horizontal\\n6. Garis vertikal\\n7. Garis horizontal\\n8. Garis vertikal\\n9. Garis miring ke kiri\\n10. Garis miring ke kanan\\n11. Garis horizontal\\n12. Garis vertikal\\n13. Garis miring ke kiri\\n14. Garis miring ke kanan', gifUrl: getGifUrl('kanji', '語') },
            { char: '名', romaji: 'mei, na', meaning: 'Nama', strokeOrder: '1. Garis miring ke kiri\\n2. Garis miring ke kanan\\n3. Garis horizontal\\n4. Garis vertikal\\n5. Garis horizontal\\n6. Garis miring ke kiri', gifUrl: getGifUrl('kanji', '名') },
            { char: '前', romaji: 'zen, mae', meaning: 'Depan, Sebelum', strokeOrder: '1. Garis vertikal\\n2. Garis horizontal\\n3. Garis horizontal\\n4. Garis vertikal\\n5. Garis horizontal\\n6. Garis vertikal\\n7. Garis miring ke kiri\\n8. Garis miring ke kanan\\n9. Garis horizontal\\n10. Garis vertikal\\n11. Garis miring ke kiri\\n12. Garis miring ke kanan\\n13. Garis horizontal', gifUrl: getGifUrl('kanji', '前') },
            { char: '国', romaji: 'koku, kuni', meaning: 'Negara', strokeOrder: '1. Garis vertikal\\n2. Garis horizontal\\n3. Garis horizontal\\n4. Garis vertikal\\n5. Garis horizontal\\n6. Garis vertikal\\n7. Garis horizontal\\n8. Garis vertikal', gifUrl: getGifUrl('kanji', '国') },
            { char: '時', romaji: 'ji, toki', meaning: 'Waktu', strokeOrder: '1. Garis vertikal\\n2. Garis horizontal\\n3. Garis horizontal\\n4. Garis vertikal\\n5. Garis horizontal\\n6. Garis vertikal\\n7. Garis miring ke kiri\\n8. Garis miring ke kanan\\n9. Garis horizontal\\n10. Garis vertikal\\n11. Garis miring ke kiri\\n12. Garis miring ke kanan\\n13. Garis horizontal', gifUrl: getGifUrl('kanji', '時') },
            { char: '間', romaji: 'kan, aida', meaning: 'Antara', strokeOrder: '1. Garis vertikal\\n2. Garis horizontal\\n3. Garis horizontal\\n4. Garis vertikal\\n5. Garis horizontal\\n6. Garis vertikal\\n7. Garis horizontal\\n8. Garis vertikal', gifUrl: getGifUrl('kanji', '間') },
            { char: '話', romaji: 'wa, hana(su)', meaning: 'Bicara', strokeOrder: '1. Garis vertikal\\n2. Garis horizontal\\n3. Garis horizontal\\n4. Garis vertikal\\n5. Garis horizontal\\n6. Garis vertikal\\n7. Garis miring ke kiri\\n8. Garis miring ke kanan\\n9. Garis horizontal\\n10. Garis vertikal\\n11. Garis miring ke kiri\\n12. Garis miring ke kanan\\n13. Garis horizontal', gifUrl: getGifUrl('kanji', '話') },
            { char: '聞', romaji: 'bun, ki(ku)', meaning: 'Dengar', strokeOrder: '1. Garis vertikal\\n2. Garis horizontal\\n3. Garis horizontal\\n4. Garis vertikal\\n5. Garis horizontal\\n6. Garis vertikal\\n7. Garis miring ke kiri\\n8. Garis miring ke kanan\\n9. Garis horizontal\\n10. Garis vertikal\\n11. Garis miring ke kiri\\n12. Garis miring ke kanan\\n13. Garis horizontal', gifUrl: getGifUrl('kanji', '聞') },
            { char: '書', romaji: 'sho, ka(ku)', meaning: 'Tulis', strokeOrder: '1. Garis vertikal\\n2. Garis horizontal\\n3. Garis horizontal\\n4. Garis vertikal\\n5. Garis horizontal\\n6. Garis vertikal\\n7. Garis miring ke kiri\\n8. Garis miring ke kanan\\n9. Garis horizontal\\n10. Garis vertikal\\n11. Garis miring ke kiri\\n12. Garis miring ke kanan\\n13. Garis horizontal', gifUrl: getGifUrl('kanji', '書') },
            { char: '読', romaji: 'doku, yo(mu)', meaning: 'Baca', strokeOrder: '1. Garis vertikal\\n2. Garis horizontal\\n3. Garis horizontal\\n4. Garis vertikal\\n5. Garis horizontal\\n6. Garis vertikal\\n7. Garis miring ke kiri\\n8. Garis miring ke kanan\\n9. Garis horizontal\\n10. Garis vertikal\\n11. Garis miring ke kiri\\n12. Garis miring ke kanan\\n13. Garis horizontal', gifUrl: getGifUrl('kanji', '読') },
            { char: '見', romaji: 'ken, mi(ru)', meaning: 'Lihat', strokeOrder: '1. Garis vertikal\\n2. Garis horizontal\\n3. Garis horizontal\\n4. Garis vertikal\\n5. Garis horizontal\\n6. Garis vertikal\\n7. Garis miring ke kiri\\n8. Garis miring ke kanan\\n9. Garis horizontal\\n10. Garis vertikal\\n11. Garis miring ke kiri\\n12. Garis miring ke kanan\\n13. Garis horizontal', gifUrl: getGifUrl('kanji', '見') },
            { char: '行', romaji: 'kou, i(ku)', meaning: 'Pergi', strokeOrder: '1. Garis vertikal\\n2. Garis horizontal\\n3. Garis horizontal\\n4. Garis vertikal\\n5. Garis horizontal\\n6. Garis vertikal\\n7. Garis miring ke kiri\\n8. Garis miring ke kanan\\n9. Garis horizontal\\n10. Garis vertikal\\n11. Garis miring ke kiri\\n12. Garis miring ke kanan\\n13. Garis horizontal', gifUrl: getGifUrl('kanji', '行') },
            { char: '来', romaji: 'rai, ku(ru)', meaning: 'Datang', strokeOrder: '1. Garis vertikal\\n2. Garis horizontal\\n3. Garis horizontal\\n4. Garis vertikal\\n5. Garis horizontal\\n6. Garis vertikal\\n7. Garis miring ke kiri\\n8. Garis miring ke kanan\\n9. Garis horizontal\\n10. Garis vertikal\\n11. Garis miring ke kiri\\n12. Garis miring ke kanan\\n13. Garis horizontal', gifUrl: getGifUrl('kanji', '来') },
            { char: '出', romaji: 'shutsu, de(ru)', meaning: 'Keluar', strokeOrder: '1. Garis vertikal\\n2. Garis horizontal\\n3. Garis horizontal\\n4. Garis vertikal\\n5. Garis horizontal\\n6. Garis vertikal\\n7. Garis miring ke kiri\\n8. Garis miring ke kanan\\n9. Garis horizontal\\n10. Garis vertikal\\n11. Garis miring ke kiri\\n12. Garis miring ke kanan\\n13. Garis horizontal', gifUrl: getGifUrl('kanji', '出') },
            { char: '入', romaji: 'nyuu, hai(ru)', meaning: 'Masuk', strokeOrder: '1. Garis vertikal\\n2. Garis horizontal\\n3. Garis horizontal\\n4. Garis vertikal\\n5. Garis horizontal\\n6. Garis vertikal\\n7. Garis miring ke kiri\\n8. Garis miring ke kanan\\n9. Garis horizontal\\n10. Garis vertikal\\n11. Garis miring ke kiri\\n12. Garis miring ke kanan\\n13. Garis horizontal', gifUrl: getGifUrl('kanji', '入') },
            { char: '会', romaji: 'kai, a(u)', meaning: 'Bertemu', strokeOrder: '1. Garis vertikal\\n2. Garis horizontal\\n3. Garis horizontal\\n4. Garis vertikal\\n5. Garis horizontal\\n6. Garis vertikal\\n7. Garis miring ke kiri\\n8. Garis miring ke kanan\\n9. Garis horizontal\\n10. Garis vertikal\\n11. Garis miring ke kiri\\n12. Garis miring ke kanan\\n13. Garis horizontal', gifUrl: getGifUrl('kanji', '会') },
            { char: '社', romaji: 'sha', meaning: 'Perusahaan', strokeOrder: '1. Garis vertikal\\n2. Garis horizontal\\n3. Garis horizontal\\n4. Garis vertikal\\n5. Garis horizontal\\n6. Garis vertikal\\n7. Garis miring ke kiri\\n8. Garis miring ke kanan\\n9. Garis horizontal\\n10. Garis vertikal\\n11. Garis miring ke kiri\\n12. Garis miring ke kanan\\n13. Garis horizontal', gifUrl: getGifUrl('kanji', '社') },
            { char: '員', romaji: 'in', meaning: 'Anggota', strokeOrder: '1. Garis vertikal\\n2. Garis horizontal\\n3. Garis horizontal\\n4. Garis vertikal\\n5. Garis horizontal\\n6. Garis vertikal\\n7. Garis miring ke kiri\\n8. Garis miring ke kanan\\n9. Garis horizontal\\n10. Garis vertikal\\n11. Garis miring ke kiri\\n12. Garis miring ke kanan\\n13. Garis horizontal', gifUrl: getGifUrl('kanji', '員') },
            { char: '店', romaji: 'ten, mise', meaning: 'Toko', strokeOrder: '1. Garis vertikal\\n2. Garis horizontal\\n3. Garis horizontal\\n4. Garis vertikal\\n5. Garis horizontal\\n6. Garis vertikal\\n7. Garis miring ke kiri\\n8. Garis miring ke kanan\\n9. Garis horizontal\\n10. Garis vertikal\\n11. Garis miring ke kiri\\n12. Garis miring ke kanan\\n13. Garis horizontal', gifUrl: getGifUrl('kanji', '店') },
            { char: '駅', romaji: 'eki', meaning: 'Stasiun', strokeOrder: '1. Garis vertikal\\n2. Garis horizontal\\n3. Garis horizontal\\n4. Garis vertikal\\n5. Garis horizontal\\n6. Garis vertikal\\n7. Garis miring ke kiri\\n8. Garis miring ke kanan\\n9. Garis horizontal\\n10. Garis vertikal\\n11. Garis miring ke kiri\\n12. Garis miring ke kanan\\n13. Garis horizontal', gifUrl: getGifUrl('kanji', '駅') },
            { char: '電', romaji: 'den', meaning: 'Listrik', strokeOrder: '1. Garis vertikal\\n2. Garis horizontal\\n3. Garis horizontal\\n4. Garis vertikal\\n5. Garis horizontal\\n6. Garis vertikal\\n7. Garis miring ke kiri\\n8. Garis miring ke kanan\\n9. Garis horizontal\\n10. Garis vertikal\\n11. Garis miring ke kiri\\n12. Garis miring ke kanan\\n13. Garis horizontal', gifUrl: getGifUrl('kanji', '電') },
            { char: '車', romaji: 'sha, kuruma', meaning: 'Mobil', strokeOrder: '1. Garis vertikal\\n2. Garis horizontal\\n3. Garis horizontal\\n4. Garis vertikal\\n5. Garis horizontal\\n6. Garis vertikal\\n7. Garis miring ke kiri\\n8. Garis miring ke kanan\\n9. Garis horizontal\\n10. Garis vertikal\\n11. Garis miring ke kiri\\n12. Garis miring ke kanan\\n13. Garis horizontal', gifUrl: getGifUrl('kanji', '車') },
            { char: '食', romaji: 'shoku, ta(beru)', meaning: 'Makan', strokeOrder: '1. Garis vertikal\\n2. Garis horizontal\\n3. Garis horizontal\\n4. Garis vertikal\\n5. Garis horizontal\\n6. Garis vertikal\\n7. Garis miring ke kiri\\n8. Garis miring ke kanan\\n9. Garis horizontal\\n10. Garis vertikal\\n11. Garis miring ke kiri\\n12. Garis miring ke kanan\\n13. Garis horizontal', gifUrl: getGifUrl('kanji', '食') },
            { char: '飲', romaji: 'in, no(mu)', meaning: 'Minum', strokeOrder: '1. Garis vertikal\\n2. Garis horizontal\\n3. Garis horizontal\\n4. Garis vertikal\\n5. Garis horizontal\\n6. Garis vertikal\\n7. Garis miring ke kiri\\n8. Garis miring ke kanan\\n9. Garis horizontal\\n10. Garis vertikal\\n11. Garis miring ke kiri\\n12. Garis miring ke kanan\\n13. Garis horizontal', gifUrl: getGifUrl('kanji', '飲') },
            { char: '買', romaji: 'bai, ka(u)', meaning: 'Beli', strokeOrder: '1. Garis vertikal\\n2. Garis horizontal\\n3. Garis horizontal\\n4. Garis vertikal\\n5. Garis horizontal\\n6. Garis vertikal\\n7. Garis miring ke kiri\\n8. Garis miring ke kanan\\n9. Garis horizontal\\n10. Garis vertikal\\n11. Garis miring ke kiri\\n12. Garis miring ke kanan\\n13. Garis horizontal', gifUrl: getGifUrl('kanji', '買') },
            { char: '高', romaji: 'kou, taka(i)', meaning: 'Tinggi, Mahal', strokeOrder: '1. Garis vertikal\\n2. Garis horizontal\\n3. Garis horizontal\\n4. Garis vertikal\\n5. Garis horizontal\\n6. Garis vertikal\\n7. Garis miring ke kiri\\n8. Garis miring ke kanan\\n9. Garis horizontal\\n10. Garis vertikal\\n11. Garis miring ke kiri\\n12. Garis miring ke kanan\\n13. Garis horizontal', gifUrl: getGifUrl('kanji', '高') },
            { char: '安', romaji: 'an, yasu(i)', meaning: 'Murah, Tenang', strokeOrder: '1. Garis vertikal\\n2. Garis horizontal\\n3. Garis horizontal\\n4. Garis vertikal\\n5. Garis horizontal\\n6. Garis vertikal\\n7. Garis miring ke kiri\\n8. Garis miring ke kanan\\n9. Garis horizontal\\n10. Garis vertikal\\n11. Garis miring ke kiri\\n12. Garis miring ke kanan\\n13. Garis horizontal', gifUrl: getGifUrl('kanji', '安') },
        ];


        let currentScript = 'hiragana';
        let currentIndex = 0;
        let characters = hiraganaCharacters;

        const canvas = document.getElementById('writingCanvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;

        // Global variable to store the opaque sample image data for snapping
        let currentSampleImageData = null;

        // Variables for brush effect (speed-based thickness)
        let lastX = 0;
        let lastY = 0;
        let lastTime = 0;
        const minLineWidth = 5; // Minimum line thickness - Increased
        const maxLineWidth = 20; // Maximum line thickness - Increased
        const maxSpeed = 10; // Max speed (pixels/ms) to influence line width. Adjust as needed.

        // DOM Elements
        const romajiDisplay = document.getElementById('romaji-display'); 
        const meaningDisplay = document.getElementById('meaning-display');
        const strokeOrderText = document.getElementById('stroke-order-text');
        const characterGif = document.getElementById('character-gif');
        const clearBtn = document.getElementById('clear-btn');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const hiraganaBtn = document.getElementById('hiragana-btn');
        const katakanaBtn = document.getElementById('katakana-btn');
        const kanjiBtn = document.getElementById('kanji-btn');
        const progressDisplay = document.getElementById('progress-display'); // New element for progress
        const checkBtn = document.getElementById('check-btn'); // New button
        const feedbackMessage = document.getElementById('feedback-message'); // New div for messages

        // Initialize canvas settings
        ctx.lineCap = 'round';
        ctx.strokeStyle = '#333';
        // Shadow properties for "brush mode" effect
        ctx.shadowBlur = 2; 
        ctx.shadowColor = 'rgba(0, 0, 0, 0.3)'; 
        ctx.shadowOffsetX = 1; 
        ctx.shadowOffsetY = 1; 

        // Function to draw Japanese character on canvas with transparency
        // Added 'alpha' parameter with a default value for flexibility
        const drawJapaneseCharacterOnCanvas = (char, targetCtx, targetCanvas, alpha = 0.15, storeOpaqueSample = false) => {
            if (!targetCtx || targetCanvas.width === 0 || targetCanvas.height === 0) return; // Ensure canvas is ready

            targetCtx.save(); // Save current canvas state
            targetCtx.clearRect(0, 0, targetCanvas.width, targetCanvas.height); // Clear before drawing sample
            targetCtx.globalAlpha = alpha; // Use the passed alpha value
            targetCtx.font = 'bold ' + (targetCanvas.width * 0.8) + 'px Arial, sans-serif'; // Adjust font size dynamically
            targetCtx.fillStyle = '#d1d5db'; // Set color (light gray)
            targetCtx.textAlign = 'center';
            targetCtx.textBaseline = 'middle';

            // Calculate position to center the text on the canvas
            const x = targetCanvas.width / 2;
            const y = targetCanvas.height / 2;

            targetCtx.fillText(char, x, y);

            if (storeOpaqueSample) {
                // Create a temporary canvas for the opaque sample
                const tempOpaqueCanvas = document.createElement('canvas');
                tempOpaqueCanvas.width = targetCanvas.width;
                tempOpaqueCanvas.height = targetCanvas.height;
                const tempOpaqueCtx = tempOpaqueCanvas.getContext('2d');
                
                tempOpaqueCtx.font = 'bold ' + (targetCanvas.width * 0.8) + 'px Arial, sans-serif';
                tempOpaqueCtx.fillStyle = '#d1d5db'; // Or any opaque color
                tempOpaqueCtx.textAlign = 'center';
                tempOpaqueCtx.textBaseline = 'middle';
                tempOpaqueCtx.fillText(char, x, y);
                currentSampleImageData = tempOpaqueCtx.getImageData(0, 0, tempOpaqueCanvas.width, tempOpaqueCanvas.height);
            }

            targetCtx.restore(); // Restore canvas state (resets globalAlpha, etc.)
        };

        // Function to compare user's drawing with sample
        const checkWriting = () => {
            const currentCharacterData = characters[currentIndex];
            if (!currentCharacterData) {
                feedbackMessage.textContent = 'Tidak ada karakter untuk diperiksa.';
                feedbackMessage.className = 'mt-4 text-red-600 font-semibold error';
                return;
            }

            if (!currentSampleImageData) { // Use global sample data
                feedbackMessage.textContent = 'Data karakter sampel tidak tersedia.';
                feedbackMessage.className = 'mt-4 text-red-600 font-semibold error';
                return;
            }
            
            // Get pixel data from both canvases
            const userImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const samplePixels = currentSampleImageData.data; // Use the globally stored opaque sample data

            const userPixels = userImageData.data;

            let totalSampleTargetPixels = 0; // Pixels in the sample that should be drawn
            let matchingUserPixels = 0; // Pixels drawn by user that match sample target pixels
            let totalUserDrawnPixels = 0; // Total pixels drawn by the user

            // Define a threshold for how "dark" a user pixel needs to be to be considered a stroke
            // This needs to be significantly higher than the transparent guide's alpha (which is ~38)
            const userStrokeAlphaThreshold = 100; // Adjusted to be higher than transparent guide's alpha

            // Define a threshold for how "opaque" a sample pixel needs to be to be considered part of the character
            const sampleCharacterAlphaThreshold = 50; // The sample is drawn with alpha 1 (255), so anything > 0 should work.

            for (let i = 0; i < samplePixels.length; i += 4) {
                const sampleAlpha = samplePixels[i + 3]; // Alpha channel of sample
                const userAlpha = userPixels[i + 3];     // Alpha channel of user's canvas

                // Check if the sample pixel is part of the character (not background)
                if (sampleAlpha > sampleCharacterAlphaThreshold) {
                    totalSampleTargetPixels++; // Count this as a target pixel from the sample

                    // Check if the corresponding user pixel is a significant stroke (not just the transparent guide)
                    if (userAlpha > userStrokeAlphaThreshold) {
                        matchingUserPixels++; // Count this as a matching pixel
                    }
                }

                // Separately count total user drawn pixels
                if (userAlpha > userStrokeAlphaThreshold) {
                    totalUserDrawnPixels++;
                }
            }

            // Calculate Jaccard-like index
            let denominator = totalSampleTargetPixels + totalUserDrawnPixels - matchingUserPixels;
            const matchPercentage = denominator > 0 ? (matchingUserPixels / denominator) * 100 : 0;

            // Adjust thresholds for feedback to be more forgiving
            const goodMatchThreshold = 60; 
            const decentMatchThreshold = 30; 

            if (matchPercentage >= goodMatchThreshold) { 
                feedbackMessage.textContent = `Bagus sekali!`; // Removed percentage
                feedbackMessage.className = 'mt-4 text-green-600 font-semibold success';
            } else if (matchPercentage >= decentMatchThreshold) {
                feedbackMessage.textContent = `Cukup baik, tapi bisa lebih baik lagi.`; // Removed percentage
                feedbackMessage.className = 'mt-4 text-orange-600 font-semibold warning';
            } else {
                feedbackMessage.textContent = `Coba lagi.`; // Removed percentage
                feedbackMessage.className = 'mt-4 text-red-600 font-semibold error';
            }
        };

        // Function to render the current character data
        const renderCharacter = () => {
            const currentCharacterData = characters[currentIndex];
            if (currentCharacterData) {
                romajiDisplay.textContent = `Romaji: ${currentCharacterData.romaji}`; 
                meaningDisplay.textContent = currentCharacterData.meaning ? `Arti: ${currentCharacterData.meaning}` : '';
                strokeOrderText.textContent = currentCharacterData.strokeOrder;
                characterGif.src = currentCharacterData.gifUrl;
                characterGif.alt = `Stroke order for ${currentCharacterData.char}`;
                // Update progress display
                progressDisplay.textContent = `${currentIndex + 1} / ${characters.length}`;
                // Clear canvas when character changes
                // Pass true to drawJapaneseCharacterOnCanvas to store the opaque sample data
                drawJapaneseCharacterOnCanvas(characters[currentIndex].char, ctx, canvas, 0.15, true); 
            } else {
                // If no character data, ensure displays are clear
                romajiDisplay.textContent = 'Romaji: N/A'; 
                meaningDisplay.textContent = '';
                strokeOrderText.textContent = 'Tidak ada data urutan goresan.';
                characterGif.src = 'https://placehold.co/150x150/e0e0e0/000000?text=GIF+Tidak+Ada';
                characterGif.alt = 'No GIF available';
                progressDisplay.textContent = '0 / 0';
                clearCanvas(); // Clear canvas even if no character data
                currentSampleImageData = null; // Clear sample data if no character
            }
            // Clear feedback message on character change
            feedbackMessage.textContent = '';
            feedbackMessage.className = '';
        };

        // Canvas drawing functions
        const getEventPos = (e) => {
            const rect = canvas.getBoundingClientRect();
            if (e.touches && e.touches.length > 0) {
                return {
                    x: e.touches[0].clientX - rect.left,
                    y: e.touches[0].clientY - rect.top
                };
            }
            return {
                x: e.clientX - rect.left,
                y: e.clientY - rect.top
            };
        };

        const startDrawing = (e) => {
            e.preventDefault(); // Prevent scrolling on touch devices
            isDrawing = true;
            const { x, y } = getEventPos(e);
            ctx.beginPath();
            ctx.moveTo(x, y); // Mulai jalur di titik sentuh/klik awal
            lastX = x;
            lastY = y;
            lastTime = performance.now(); // Get high-resolution time
            ctx.lineWidth = maxLineWidth; // Start with max thickness for the first point
        };

        const draw = (e) => {
            e.preventDefault(); // Keep preventDefault here to prevent scrolling while drawing on canvas
            if (!isDrawing) return;
            let { x, y } = getEventPos(e); // Use let because x, y will be modified

            const currentTime = performance.now();
            const dx = x - lastX;
            const dy = y - lastY;
            const distance = Math.sqrt(dx * dx + dy * dy);
            const timeElapsed = currentTime - lastTime;
            let speed = timeElapsed > 0 ? distance / timeElapsed : 0;

            const clampedSpeed = Math.min(speed, maxSpeed);
            const normalizedSpeed = clampedSpeed / maxSpeed;
            const invertedNormalizedSpeed = 1 - normalizedSpeed;
            ctx.lineWidth = minLineWidth + (invertedNormalizedSpeed * (maxLineWidth - minLineWidth));
            ctx.lineWidth = Math.max(minLineWidth, Math.min(ctx.lineWidth, maxLineWidth));

            // Autocorrection/Snapping Logic
            if (currentSampleImageData) {
                const samplePixels = currentSampleImageData.data;
                const sampleWidth = canvas.width; // Assuming sample and user canvas have same dimensions
                const sampleHeight = canvas.height;

                const snapRadius = 150; // Increased radius to search for correct pixels
                const snapStrength = 0.5; // Strength to pull the stroke towards the correct path (reduced for smoother feel)
                
                let closestSamplePixelX = -1;
                let closestSamplePixelY = -1;
                let minDistanceToSample = Infinity;

                // Search for the closest opaque pixel in the sample character within the snapRadius
                for (let offsetY = -snapRadius; offsetY <= snapRadius; offsetY++) {
                    for (let offsetX = -snapRadius; offsetX <= snapRadius; offsetX++) {
                        const checkX = Math.round(x + offsetX);
                        const checkY = Math.round(y + offsetY);

                        // Ensure coordinates are within canvas bounds
                        if (checkX >= 0 && checkX < sampleWidth && checkY >= 0 && checkY < sampleHeight) {
                            const pixelIndex = (checkY * sampleWidth + checkX) * 4;
                            const sampleAlpha = samplePixels[pixelIndex + 3];

                            if (sampleAlpha > 50) { // If it's an opaque pixel from the sample character
                                const dist = Math.sqrt(offsetX * offsetX + offsetY * offsetY);
                                if (dist < minDistanceToSample) {
                                    minDistanceToSample = dist;
                                    closestSamplePixelX = checkX;
                                    closestSamplePixelY = checkY;
                                }
                            }
                        }
                    }
                }

                // If a close sample pixel is found, adjust the drawing coordinates
                if (closestSamplePixelX !== -1) {
                    x = x + (closestSamplePixelX - x) * snapStrength;
                    y = y + (closestSamplePixelY - y) * snapStrength;
                }
            }

            ctx.quadraticCurveTo(lastX, lastY, (lastX + x) / 2, (lastY + y) / 2);
            ctx.stroke();

            lastX = x;
            lastY = y;
            lastTime = currentTime;
        };

        const endDrawing = () => {
            if (!isDrawing) return;
            // Selesaikan segmen terakhir kurva kuadrat.
            // Gambar garis lurus terakhir dari titik jalur saat ini ke titik terakhir yang direkam.
            ctx.lineTo(lastX, lastY);
            ctx.stroke();
            ctx.closePath();
            isDrawing = false;
        };

        const clearCanvas = () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // Redraw transparent Japanese character after clearing
            if (characters[currentIndex]) {
                drawJapaneseCharacterOnCanvas(characters[currentIndex].char, ctx, canvas, 0.15, false); // Do not store opaque sample on clear
            }
            // Clear feedback message on clear
            feedbackMessage.textContent = '';
            feedbackMessage.className = '';
        };

        // Navigation functions
        const nextCharacter = () => {
            currentIndex = (currentIndex + 1) % characters.length;
            renderCharacter();
        };

        const prevCharacter = () => {
            currentIndex = (currentIndex - 1 + characters.length) % characters.length;
            renderCharacter();
        };

        // Script selection function
        const setScript = (scriptName) => {
            currentScript = scriptName;
            currentIndex = 0; // Reset index when script changes
            hiraganaBtn.classList.remove('bg-blue-600', 'text-white', 'shadow-md');
            hiraganaBtn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-blue-100');
            katakanaBtn.classList.remove('bg-blue-600', 'text-white', 'shadow-md');
            katakanaBtn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-blue-100');
            kanjiBtn.classList.remove('bg-blue-600', 'text-white', 'shadow-md');
            kanjiBtn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-blue-100');

            if (scriptName === 'hiragana') {
                characters = hiraganaCharacters;
                hiraganaBtn.classList.add('bg-blue-600', 'text-white', 'shadow-md');
            } else if (scriptName === 'katakana') {
                characters = katakanaCharacters;
                katakanaBtn.classList.add('bg-blue-600', 'text-white', 'shadow-md');
            } else if (scriptName === 'kanji') {
                characters = kanjiCharacters;
                kanjiBtn.classList.add('bg-blue-600', 'text-white', 'shadow-md');
            }
            renderCharacter();
        };

        // Function to resize canvas dynamically based on available space
        const resizeCanvas = () => {
            let imageData = null;
            // Only try to get image data if canvas has valid dimensions
            if (canvas.width > 0 && canvas.height > 0) {
                imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            }

            const canvasParent = canvas.parentElement; 
            if (!canvasParent) return;

            // Set canvas dimensions to fill its parent.
            // The aspect-square on the parent div will handle the square ratio.
            canvas.width = canvasParent.clientWidth;
            canvas.height = canvasParent.clientHeight; 

            // Restore image data or clear canvas
            if (imageData) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = imageData.width;
                tempCanvas.height = imageData.height;
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.putImageData(imageData, 0, 0);
                ctx.drawImage(tempCanvas, 0, 0, canvas.width, canvas.height);
            } else {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }

            // Reapply canvas styles after resize
            ctx.lineCap = 'round';
            ctx.strokeStyle = '#333';
            ctx.shadowBlur = 2;
            ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
            ctx.shadowOffsetX = 1;
            ctx.shadowOffsetY = 1;

            // Redraw transparent Japanese character after resize
            if (characters[currentIndex]) {
                drawJapaneseCharacterOnCanvas(characters[currentIndex].char, ctx, canvas, 0.15, true);
            }
        };


        // Event Listeners
        window.onload = function() {
            // Initial canvas size calculation
            resizeCanvas();

            // Canvas drawing event listeners
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', endDrawing);
            canvas.addEventListener('mouseleave', endDrawing); // End drawing if mouse leaves canvas

            canvas.addEventListener('touchstart', startDrawing, { passive: false });
            canvas.addEventListener('touchmove', draw, { passive: false });
            canvas.addEventListener('touchend', endDrawing);

            // Button event listeners
            clearBtn.addEventListener('click', clearCanvas);
            prevBtn.addEventListener('click', prevCharacter);
            nextBtn.addEventListener('click', nextCharacter);
            hiraganaBtn.addEventListener('click', () => setScript('hiragana'));
            katakanaBtn.addEventListener('click', () => setScript('katakana'));
            kanjiBtn.addEventListener('click', () => setScript('kanji'));
            checkBtn.addEventListener('click', checkWriting); // Add event listener for check button

            // Handle window resize for canvas
            window.addEventListener('resize', resizeCanvas);

            // Initial render
            setScript('hiragana'); // Start with Hiragana
        };
    </script>
</body>
</html>
