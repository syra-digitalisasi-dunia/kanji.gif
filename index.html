<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aksara Jepang Interaktif</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the canvas to ensure it's responsive and centered */
        canvas {
            background-color: #f9fafb; /* Light gray background for canvas */
            display: block;
            width: 100%;
            height: 100%;
            border-radius: 0.375rem; /* rounded-md */
        }
        /* Ensure font Inter is used */
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-100 to-purple-100 font-sans text-gray-800 p-4 flex flex-col items-center">

    <!-- Header Aplikasi -->
    <header class="w-full max-w-2xl text-center mb-8">
        <h1 class="text-4xl font-extrabold text-blue-700 mb-2">Aksara Jepang Interaktif</h1>
        <p class="text-lg text-gray-600">Latih goresan Hiragana, Katakana, dan Kanji Anda!</p>
    </header>

    <!-- Navigasi Script -->
    <nav class="mb-8 flex space-x-4 bg-white p-2 rounded-full shadow-lg">
        <button id="hiragana-btn" class="px-6 py-3 rounded-full font-semibold transition duration-300 ease-in-out bg-blue-600 text-white shadow-md">
            Hiragana
        </button>
        <button id="katakana-btn" class="px-6 py-3 rounded-full font-semibold transition duration-300 ease-in-out bg-gray-200 text-gray-700 hover:bg-blue-100">
            Katakana
        </button>
        <button id="kanji-btn" class="px-6 py-3 rounded-full font-semibold transition duration-300 ease-in-out bg-gray-200 text-gray-700 hover:bg-blue-100">
            Kanji
        </button>
    </nav>

    <!-- Area Latihan -->
    <main class="w-full max-w-md">
        <div class="flex flex-col items-center p-4 bg-white rounded-lg shadow-md w-full mx-auto">
            <!-- Display GIF -->
            <div class="mb-4 w-32 h-32 flex items-center justify-center bg-gray-100 rounded-md overflow-hidden">
                <img id="character-gif" src="" alt="Stroke order GIF" class="w-full h-full object-contain"
                     onerror="this.onerror=null;this.src='https://placehold.co/150x150/e0e0e0/000000?text=GIF+Tidak+Ada';">
            </div>

            <!-- Romaji display -->
            <div id="romaji-display" class="text-xl text-gray-600 mb-2"></div>
            
            <div id="meaning-display" class="text-lg text-gray-700 mb-4"></div>
            <div id="stroke-order-display" class="text-sm text-gray-500 mb-4 p-2 bg-gray-50 rounded-md w-full">
                <h4 class="font-semibold mb-1">Urutan Goresan:</h4>
                <pre id="stroke-order-text" class="whitespace-pre-wrap"></pre>
            </div>
            <div class="relative w-full aspect-square border-2 border-gray-300 rounded-md overflow-hidden bg-gray-50">
                <canvas id="writingCanvas"></canvas>
                <!-- Garis bantu untuk kanvas -->
                <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                    <div class="absolute w-full h-px bg-gray-300 transform -translate-y-1/2"></div>
                    <div class="absolute h-full w-px bg-gray-300 transform -translate-x-1/2"></div>
                </div>
            </div>
            <button id="clear-btn" class="mt-4 px-6 py-2 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 transition duration-300 ease-in-out">
                Hapus
            </button>
            <button id="check-btn" class="mt-2 px-6 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition duration-300 ease-in-out">
                Periksa Tulisan
            </button>
            <div id="feedback-message" class="mt-4 text-center text-sm"></div>
        </div>
    </main>

    <!-- Navigasi Karakter -->
    <div class="mt-6 flex space-x-4 items-center">
        <button id="prev-btn" class="px-6 py-3 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 transition duration-300 ease-in-out flex items-center justify-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            Sebelumnya
        </button>
        <span id="progress-display" class="text-lg font-semibold text-gray-700"></span>
        <button id="next-btn" class="px-6 py-3 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 transition duration-300 ease-in-out flex items-center justify-center">
            Berikutnya
            <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
        </button>
    </div>

    <script>
        // Helper function to generate GIF URLs from the GitHub repository
        const getGifUrl = (scriptType, char) => {
            const encodedChar = encodeURIComponent(char);
            // Using raw.githubusercontent.com for direct access to files
            return `https://raw.githubusercontent.com/syra-digitalisasi-dunia/kanji.gif/master/${scriptType}/gif/150x150/${encodedChar}.gif`;
        };

        // Data karakter Hiragana (All basic 46)
        const hiraganaCharacters = [
            { char: 'あ', romaji: 'a', strokeOrder: '1. Kiri atas ke kanan bawah\n2. Melengkung ke kanan bawah\n3. Lingkaran kecil di tengah', gifUrl: getGifUrl('hiragana', 'あ') },
            { char: 'い', romaji: 'i', strokeOrder: '1. Kiri atas ke kanan bawah\n2. Sedikit melengkung ke kanan', gifUrl: getGifUrl('hiragana', 'い') },
            { char: 'う', romaji: 'u', strokeOrder: '1. Garis pendek horizontal\n2. Melengkung ke bawah', gifUrl: getGifUrl('hiragana', 'う') },
            { char: 'え', romaji: 'e', strokeOrder: '1. Garis horizontal\n2. Garis vertikal melengkung\n3. Garis pendek horizontal', gifUrl: getGifUrl('hiragana', 'え') },
            { char: 'お', romaji: 'o', strokeOrder: '1. Garis horizontal\n2. Garis vertikal melengkung\n3. Lingkaran kecil di kanan', gifUrl: getGifUrl('hiragana', 'お') },
            { char: 'か', romaji: 'ka', strokeOrder: '1. Garis horizontal ke kanan\n2. Garis vertikal ke bawah\n3. Garis miring ke kanan bawah', gifUrl: getGifUrl('hiragana', 'か') },
            { char: 'き', romaji: 'ki', strokeOrder: '1. Garis horizontal\n2. Garis horizontal\n3. Garis horizontal\n4. Garis miring ke kanan bawah', gifUrl: getGifUrl('hiragana', 'き') },
            { char: 'く', romaji: 'ku', strokeOrder: '1. Garis melengkung ke kanan bawah', gifUrl: getGifUrl('hiragana', 'く') },
            { char: 'け', romaji: 'ke', strokeOrder: '1. Garis horizontal\n2. Garis vertikal ke bawah\n3. Garis miring ke kanan bawah', gifUrl: getGifUrl('hiragana', 'け') },
            { char: 'こ', romaji: 'ko', strokeOrder: '1. Garis horizontal\n2. Garis horizontal di bawahnya', gifUrl: getGifUrl('hiragana', 'こ') },
            { char: 'さ', romaji: 'sa', strokeOrder: '1. Garis horizontal\n2. Garis vertikal melengkung\n3. Garis miring ke kanan bawah', gifUrl: getGifUrl('hiragana', 'さ') },
            { char: 'し', romaji: 'shi', strokeOrder: '1. Garis melengkung ke bawah', gifUrl: getGifUrl('hiragana', 'し') },
            { char: 'す', romaji: 'su', strokeOrder: '1. Garis horizontal\n2. Garis vertikal melengkung\n3. Lingkaran kecil di tengah', gifUrl: getGifUrl('hiragana', 'す') },
            { char: 'せ', romaji: 'se', strokeOrder: '1. Garis horizontal\n2. Garis vertikal melengkung', gifUrl: getGifUrl('hiragana', 'se') },
            { char: 'そ', romaji: 'so', strokeOrder: '1. Garis melengkung ke bawah', gifUrl: getGifUrl('hiragana', 'そ') },
            { char: 'た', romaji: 'ta', strokeOrder: '1. Garis horizontal\n2. Garis vertikal\n3. Garis horizontal\n4. Garis miring ke kanan bawah', gifUrl: getGifUrl('hiragana', 'た') },
            { char: 'ち', romaji: 'chi', strokeOrder: '1. Garis horizontal\n2. Garis vertikal melengkung', gifUrl: getGifUrl('hiragana', 'ち') },
            { char: 'つ', romaji: 'tsu', strokeOrder: '1. Garis melengkung ke kanan bawah', gifUrl: getGifUrl('hiragana', 'つ') },
            { char: 'て', romaji: 'te', strokeOrder: '1. Garis melengkung ke bawah', gifUrl: getGifUrl('hiragana', 'て') },
            { char: 'と', romaji: 'to', strokeOrder: '1. Garis pendek\n2. Garis melengkung ke bawah', gifUrl: getGifUrl('hiragana', 'と') },
            { char: 'な', romaji: 'na', strokeOrder: '1. Garis horizontal\n2. Garis vertikal\n3. Garis pendek\n4. Garis melengkung ke bawah', gifUrl: getGifUrl('hiragana', 'な') },
            { char: 'に', romaji: 'ni', strokeOrder: '1. Garis horizontal\n2. Garis vertikal melengkung', gifUrl: getGifUrl('hiragana', 'に') },
            { char: 'ぬ', romaji: 'nu', strokeOrder: '1. Garis horizontal\n2. Garis melengkung ke bawah\n3. Lingkaran kecil', gifUrl: getGifUrl('hiragana', 'ぬ') },
            { char: 'ね', romaji: 'ne', strokeOrder: '1. Garis horizontal\n2. Garis vertikal melengkung\n3. Lingkaran kecil', gifUrl: getGifUrl('hiragana', 'ね') },
            { char: 'の', romaji: 'no', strokeOrder: '1. Garis melengkung ke bawah', gifUrl: getGifUrl('hiragana', 'の') },
            { char: 'は', romaji: 'ha', strokeOrder: '1. Garis vertikal\n2. Garis horizontal\n3. Garis melengkung ke bawah', gifUrl: getGifUrl('hiragana', 'は') },
            { char: 'ひ', romaji: 'hi', strokeOrder: '1. Garis melengkung ke bawah', gifUrl: getGifUrl('hiragana', 'ひ') },
            { char: 'ふ', romaji: 'fu', strokeOrder: '1. Garis horizontal\n2. Garis melengkung ke bawah', gifUrl: getGifUrl('hiragana', 'ふ') },
            { char: 'へ', romaji: 'he', strokeOrder: '1. Garis melengkung ke bawah', gifUrl: getGifUrl('hiragana', 'へ') },
            { char: 'ほ', romaji: 'ho', strokeOrder: '1. Garis vertikal\n2. Garis horizontal\n3. Garis horizontal\n4. Garis melengkung ke bawah', gifUrl: getGifUrl('hiragana', 'ほ') },
            { char: 'ま', romaji: 'ma', strokeOrder: '1. Garis horizontal\n2. Garis vertikal\n3. Garis melengkung ke bawah', gifUrl: getGifUrl('hiragana', 'ま') },
            { char: 'み', romaji: 'mi', strokeOrder: '1. Garis vertikal melengkung\n2. Garis vertikal melengkung', gifUrl: getGifUrl('hiragana', 'み') },
            { char: 'む', romaji: 'mu', strokeOrder: '1. Garis horizontal\n2. Garis vertikal melengkung\n3. Lingkaran kecil', gifUrl: getGifUrl('hiragana', 'む') },
            { char: 'め', romaji: 'me', strokeOrder: '1. Garis horizontal\n2. Garis vertikal melengkung\n3. Lingkaran kecil', gifUrl: getGifUrl('hiragana', 'め') },
            { char: 'も', romaji: 'mo', strokeOrder: '1. Garis horizontal\n2. Garis horizontal\n3. Garis vertikal melengkung\n4. Lingkaran kecil', gifUrl: getGifUrl('hiragana', 'も') },
            { char: 'や', romaji: 'ya', strokeOrder: '1. Garis melengkung ke bawah\n2. Garis melengkung ke bawah\n3. Garis vertikal', gifUrl: getGifUrl('hiragana', 'ya') },
            { char: 'ゆ', romaji: 'yu', strokeOrder: '1. Garis melengkung ke bawah\n2. Garis vertikal melengkung', gifUrl: getGifUrl('hiragana', 'ゆ') },
            { char: 'よ', romaji: 'yo', strokeOrder: '1. Garis horizontal\n2. Garis vertikal melengkung', gifUrl: getGifUrl('hiragana', 'よ') },
            { char: 'ら', romaji: 'ra', strokeOrder: '1. Garis horizontal\n2. Garis vertikal melengkung', gifUrl: getGifUrl('hiragana', 'ら') },
            { char: 'り', romaji: 'ri', strokeOrder: '1. Garis vertikal melengkung\n2. Garis vertikal melengkung', gifUrl: getGifUrl('hiragana', 'り') },
            { char: 'る', romaji: 'ru', strokeOrder: '1. Garis melengkung ke bawah', gifUrl: getGifUrl('hiragana', 'る') },
            { char: 'れ', romaji: 're', strokeOrder: '1. Garis horizontal\n2. Garis vertikal melengkung', gifUrl: getGifUrl('hiragana', 'れ') },
            { char: 'ろ', romaji: 'ro', strokeOrder: '1. Garis melengkung ke bawah', gifUrl: getGifUrl('hiragana', 'ろ') },
            { char: 'わ', romaji: 'wa', strokeOrder: '1. Garis horizontal\n2. Garis vertikal melengkung', gifUrl: getGifUrl('hiragana', 'わ') },
            { char: 'を', romaji: 'wo', strokeOrder: '1. Garis horizontal\n2. Garis vertikal\n3. Garis melengkung ke bawah', gifUrl: getGifUrl('hiragana', 'を') },
            { char: 'ん', romaji: 'n', strokeOrder: '1. Garis melengkung ke bawah', gifUrl: getGifUrl('hiragana', 'ん') },
        ];

        // Data karakter Katakana (All basic 46)
        const katakanaCharacters = [
            { char: 'ア', romaji: 'a', strokeOrder: '1. Garis horizontal\n2. Garis vertikal melengkung\n3. Garis miring ke kanan bawah', gifUrl: getGifUrl('katakana', 'ア') },
            { char: 'イ', romaji: 'i', strokeOrder: '1. Garis miring ke kanan bawah\n2. Garis miring ke kanan bawah', gifUrl: getGifUrl('katakana', 'イ') },
            { char: 'ウ', romaji: 'u', strokeOrder: '1. Garis pendek horizontal\n2. Garis melengkung ke bawah\n3. Garis pendek di kanan', gifUrl: getGifUrl('katakana', 'ウ') },
            { char: 'エ', romaji: 'e', strokeOrder: '1. Garis horizontal\n2. Garis vertikal melengkung\n3. Garis horizontal', gifUrl: getGifUrl('katakana', 'エ') },
            { char: 'オ', romaji: 'o', strokeOrder: '1. Garis horizontal\n2. Garis vertikal melengkung\n3. Garis pendek di kanan', gifUrl: getGifUrl('katakana', 'オ') },
            { char: 'カ', romaji: 'ka', strokeOrder: '1. Garis horizontal\n2. Garis vertikal ke bawah\n3. Garis miring ke kanan bawah', gifUrl: getGifUrl('katakana', 'カ') },
            { char: 'キ', romaji: 'ki', strokeOrder: '1. Garis horizontal\n2. Garis horizontal\n3. Garis miring ke kanan bawah', gifUrl: getGifUrl('katakana', 'キ') },
            { char: 'ク', romaji: 'ku', strokeOrder: '1. Garis melengkung ke kanan bawah', gifUrl: getGifUrl('katakana', 'ク') },
            { char: 'ケ', romaji: 'ke', strokeOrder: '1. Garis horizontal\n2. Garis vertikal ke bawah\n3. Garis miring ke kanan bawah', gifUrl: getGifUrl('katakana', 'ケ') },
            { char: 'コ', romaji: 'ko', strokeOrder: '1. Garis horizontal\n2. Garis vertikal ke bawah\n3. Garis horizontal', gifUrl: getGifUrl('katakana', 'コ') },
            { char: 'サ', romaji: 'sa', strokeOrder: '1. Garis horizontal\n2. Garis vertikal melengkung\n3. Garis miring ke kanan bawah', gifUrl: getGifUrl('katakana', 'サ') },
            { char: 'シ', romaji: 'shi', strokeOrder: '1. Garis melengkung ke bawah', gifUrl: getGifUrl('katakana', 'シ') },
            { char: 'ス', romaji: 'su', strokeOrder: '1. Garis horizontal\n2. Garis vertikal melengkung\n3. Garis melengkung ke bawah', gifUrl: getGifUrl('katakana', 'ス') },
            { char: 'セ', romaji: 'se', strokeOrder: '1. Garis horizontal\n2. Garis vertikal melengkung', gifUrl: getGifUrl('katakana', 'セ') },
            { char: 'ソ', romaji: 'so', strokeOrder: '1. Garis melengkung ke bawah', gifUrl: getGifUrl('katakana', 'ソ') },
            { char: 'タ', romaji: 'ta', strokeOrder: '1. Garis horizontal\n2. Garis vertikal\n3. Garis horizontal\n4. Garis miring ke kanan bawah', gifUrl: getGifUrl('katakana', 'タ') },
            { char: 'チ', romaji: 'chi', strokeOrder: '1. Garis horizontal\n2. Garis vertikal melengkung', gifUrl: getGifUrl('katakana', 'チ') },
            { char: 'ツ', romaji: 'tsu', strokeOrder: '1. Garis melengkung ke kanan bawah', gifUrl: getGifUrl('katakana', 'ツ') },
            { char: 'テ', romaji: 'te', strokeOrder: '1. Garis melengkung ke bawah', gifUrl: getGifUrl('katakana', 'テ') },
            { char: 'ト', romaji: 'to', strokeOrder: '1. Garis pendek\n2. Garis melengkung ke bawah', gifUrl: getGifUrl('katakana', 'ト') },
            { char: 'ナ', romaji: 'na', strokeOrder: '1. Garis horizontal\n2. Garis vertikal\n3. Garis pendek\n4. Garis melengkung ke bawah', gifUrl: getGifUrl('katakana', 'ナ') },
            { char: 'ニ', romaji: 'ni', strokeOrder: '1. Garis horizontal\n2. Garis vertikal melengkung', gifUrl: getGifUrl('katakana', 'ニ') },
            { char: 'ヌ', romaji: 'nu', strokeOrder: '1. Garis horizontal\n2. Garis melengkung ke bawah\n3. Garis pendek', gifUrl: getGifUrl('katakana', 'ヌ') },
            { char: 'ネ', romaji: 'ne', strokeOrder: '1. Garis horizontal\n2. Garis vertikal melengkung\n3. Garis pendek', gifUrl: getGifUrl('katakana', 'ネ') },
            { char: 'ノ', romaji: 'no', strokeOrder: '1. Garis melengkung ke bawah', gifUrl: getGifUrl('katakana', 'ノ') },
            { char: 'ハ', romaji: 'ha', strokeOrder: '1. Garis vertikal\n2. Garis horizontal\n3. Garis melengkung ke bawah', gifUrl: getGifUrl('katakana', 'ハ') },
            { char: 'ヒ', romaji: 'hi', strokeOrder: '1. Garis melengkung ke bawah', gifUrl: getGifUrl('katakana', 'ヒ') },
            { char: 'フ', romaji: 'fu', strokeOrder: '1. Garis horizontal\n2. Garis melengkung ke bawah', gifUrl: getGifUrl('katakana', 'フ') },
            { char: 'ヘ', romaji: 'he', strokeOrder: '1. Garis melengkung ke bawah', gifUrl: getGifUrl('katakana', 'ヘ') },
            { char: 'ホ', romaji: 'ho', strokeOrder: '1. Garis vertikal\n2. Garis horizontal\n3. Garis horizontal\n4. Garis melengkung ke bawah', gifUrl: getGifUrl('katakana', 'ホ') },
            { char: 'マ', romaji: 'ma', strokeOrder: '1. Garis horizontal\n2. Garis vertikal\n3. Garis melengkung ke bawah', gifUrl: getGifUrl('katakana', 'マ') },
            { char: 'ミ', romaji: 'mi', strokeOrder: '1. Garis vertikal melengkung\n2. Garis vertikal melengkung', gifUrl: getGifUrl('katakana', 'ミ') },
            { char: 'ム', romaji: 'mu', strokeOrder: '1. Garis horizontal\n2. Garis vertikal melengkung\n3. Garis pendek', gifUrl: getGifUrl('katakana', 'ム') },
            { char: 'メ', romaji: 'me', strokeOrder: '1. Garis horizontal\n2. Garis vertikal melengkung\n3. Garis pendek', gifUrl: getGifUrl('katakana', 'メ') },
            { char: 'モ', romaji: 'mo', strokeOrder: '1. Garis horizontal\n2. Garis horizontal\n3. Garis vertikal melengkung\n4. Garis pendek', gifUrl: getGifUrl('katakana', 'モ') },
            { char: 'ヤ', romaji: 'ya', strokeOrder: '1. Garis melengkung ke bawah\n2. Garis melengkung ke bawah\n3. Garis vertikal', gifUrl: getGifUrl('katakana', 'ヤ') },
            { char: 'ユ', romaji: 'yu', strokeOrder: '1. Garis melengkung ke bawah\n2. Garis vertikal melengkung', gifUrl: getGifUrl('katakana', 'ユ') },
            { char: 'ヨ', romaji: 'yo', strokeOrder: '1. Garis horizontal\n2. Garis vertikal melengkung', gifUrl: getGifUrl('katakana', 'ヨ') },
            { char: 'ラ', romaji: 'ra', strokeOrder: '1. Garis horizontal\n2. Garis vertikal melengkung', gifUrl: getGifUrl('katakana', 'ラ') },
            { char: 'リ', romaji: 'ri', strokeOrder: '1. Garis vertikal melengkung\n2. Garis vertikal melengkung', gifUrl: getGifUrl('katakana', 'リ') },
            { char: 'ル', romaji: 'ru', strokeOrder: '1. Garis melengkung ke bawah', gifUrl: getGifUrl('katakana', 'ル') },
            { char: 'レ', romaji: 're', strokeOrder: '1. Garis horizontal\n2. Garis vertikal melengkung', gifUrl: getGifUrl('katakana', 'レ') },
            { char: 'ロ', romaji: 'ro', strokeOrder: '1. Garis melengkung ke bawah', gifUrl: getGifUrl('katakana', 'ロ') },
            { char: 'ワ', romaji: 'wa', strokeOrder: '1. Garis horizontal\n2. Garis vertikal melengkung', gifUrl: getGifUrl('katakana', 'ワ') },
            { char: 'ヲ', romaji: 'wo', strokeOrder: '1. Garis horizontal\n2. Garis vertikal\n3. Garis melengkung ke bawah', gifUrl: getGifUrl('katakana', 'ヲ') },
            { char: 'ン', romaji: 'n', strokeOrder: '1. Garis melengkung ke bawah', gifUrl: getGifUrl('katakana', 'ン') },
        ];

        // Data karakter Kanji (Expanded sample)
        const kanjiCharacters = [
            { char: '日', romaji: 'nichi, hi', meaning: 'Matahari, Hari', strokeOrder: '1. Garis vertikal\n2. Garis horizontal\n3. Garis horizontal\n4. Garis horizontal', gifUrl: getGifUrl('kanji', '日') },
            { char: '月', romaji: 'getsu, tsuki', meaning: 'Bulan', strokeOrder: '1. Garis vertikal\n2. Garis horizontal\n3. Garis horizontal\n4. Garis vertikal', gifUrl: getGifUrl('kanji', '月') },
            { char: '山', romaji: 'san, yama', meaning: 'Gunung', strokeOrder: '1. Garis vertikal\n2. Garis vertikal\n3. Garis vertikal', gifUrl: getGifUrl('kanji', '山') },
            { char: '川', romaji: 'sen, kawa', meaning: 'Sungai', strokeOrder: '1. Garis vertikal\n2. Garis vertikal\n3. Garis vertikal', gifUrl: getGifUrl('kanji', '川') },
            { char: '人', romaji: 'jin, hito', meaning: 'Orang', strokeOrder: '1. Garis miring ke kiri\n2. Garis miring ke kanan', gifUrl: getGifUrl('kanji', '人') },
            { char: '木', romaji: 'boku, ki', meaning: 'Pohon', strokeOrder: '1. Garis horizontal\n2. Garis vertikal\n3. Garis miring ke kiri\n4. Garis miring ke kanan', gifUrl: getGifUrl('kanji', '木') },
            { char: '本', romaji: 'hon, moto', meaning: 'Buku, Asal', strokeOrder: '1. Garis horizontal\n2. Garis vertikal\n3. Garis horizontal\n4. Garis miring ke kiri\n5. Garis miring ke kanan', gifUrl: getGifUrl('kanji', '本') },
            { char: '大', romaji: 'dai, oo', meaning: 'Besar', strokeOrder: '1. Garis horizontal\n2. Garis miring ke kiri\n3. Garis miring ke kanan', gifUrl: getGifUrl('kanji', '大') },
            { char: '学', romaji: 'gaku, mana(bu)', meaning: 'Belajar', strokeOrder: '1. Garis miring ke kanan\n2. Garis miring ke kiri\n3. Garis horizontal\n4. Garis vertikal\n5. Garis horizontal\n6. Garis miring ke kiri\n7. Garis miring ke kanan\n8. Garis miring ke kiri', gifUrl: getGifUrl('kanji', '学') },
            { char: '校', romaji: 'kou', meaning: 'Sekolah', strokeOrder: '1. Garis horizontal\n2. Garis vertikal\n3. Garis horizontal\n4. Garis miring ke kiri\n5. Garis miring ke kanan\n6. Garis horizontal\n7. Garis vertikal\n8. Garis horizontal\n9. Garis vertikal\n10. Garis horizontal', gifUrl: getGifUrl('kanji', '校') },
            { char: '水', romaji: 'sui, mizu', meaning: 'Air', strokeOrder: '1. Garis vertikal\n2. Garis vertikal\n3. Garis vertikal', gifUrl: getGifUrl('kanji', '水') },
            { char: '火', romaji: 'ka, hi', meaning: 'Api', strokeOrder: '1. Garis miring ke kiri\n2. Garis miring ke kanan\n3. Garis miring ke kiri\n4. Garis miring ke kanan', gifUrl: getGifUrl('kanji', '火') },
            { char: '土', romaji: 'do, tsuchi', meaning: 'Tanah', strokeOrder: '1. Garis horizontal\n2. Garis vertikal\n3. Garis horizontal', gifUrl: getGifUrl('kanji', '土') },
            { char: '金', romaji: 'kin, kane', meaning: 'Emas, Uang', strokeOrder: '1. Garis miring ke kiri\n2. Garis miring ke kanan\n3. Garis horizontal\n4. Garis vertikal\n5. Garis horizontal\n6. Garis miring ke kiri\n7. Garis miring ke kanan', gifUrl: getGifUrl('kanji', '金') },
            { char: '語', romaji: 'go', meaning: 'Bahasa', strokeOrder: '1. Garis vertikal\n2. Garis horizontal\n3. Garis horizontal\n4. Garis vertikal\n5. Garis horizontal\n6. Garis vertikal\n7. Garis horizontal\n8. Garis vertikal\n9. Garis miring ke kiri\n10. Garis miring ke kanan\n11. Garis horizontal\n12. Garis vertikal\n13. Garis miring ke kiri\n14. Garis miring ke kanan', gifUrl: getGifUrl('kanji', '語') },
            { char: '名', romaji: 'mei, na', meaning: 'Nama', strokeOrder: '1. Garis miring ke kiri\n2. Garis miring ke kanan\n3. Garis horizontal\n4. Garis vertikal\n5. Garis horizontal\n6. Garis miring ke kiri', gifUrl: getGifUrl('kanji', '名') },
            { char: '前', romaji: 'zen, mae', meaning: 'Depan, Sebelum', strokeOrder: '1. Garis vertikal\n2. Garis horizontal\n3. Garis horizontal\n4. Garis vertikal\n5. Garis horizontal\n6. Garis miring ke kiri\n7. Garis miring ke kanan\n8. Garis vertikal\n9. Garis horizontal', gifUrl: getGifUrl('kanji', '前') },
            { char: '国', romaji: 'koku, kuni', meaning: 'Negara', strokeOrder: '1. Garis vertikal\n2. Garis horizontal\n3. Garis horizontal\n4. Garis vertikal\n5. Garis horizontal\n6. Garis vertikal\n7. Garis horizontal\n8. Garis vertikal', gifUrl: getGifUrl('kanji', '国') },
            { char: '時', romaji: 'ji, toki', meaning: 'Waktu', strokeOrder: '1. Garis vertikal\n2. Garis horizontal\n3. Garis horizontal\n4. Garis vertikal\n5. Garis horizontal\n6. Garis vertikal\n7. Garis miring ke kiri\n8. Garis miring ke kanan\n9. Garis horizontal\n10. Garis vertikal', gifUrl: getGifUrl('kanji', '時') },
            { char: '間', romaji: 'kan, aida', meaning: 'Antara', strokeOrder: '1. Garis vertikal\n2. Garis horizontal\n3. Garis horizontal\n4. Garis vertikal\n5. Garis horizontal\n6. Garis vertikal\n7. Garis horizontal\n8. Garis vertikal', gifUrl: getGifUrl('kanji', '間') },
            { char: '話', romaji: 'wa, hana(su)', meaning: 'Bicara', strokeOrder: '1. Garis vertikal\n2. Garis horizontal\n3. Garis horizontal\n4. Garis vertikal\n5. Garis horizontal\n6. Garis vertikal\n7. Garis miring ke kiri\n8. Garis miring ke kanan\n9. Garis horizontal\n10. Garis vertikal\n11. Garis miring ke kiri\n12. Garis miring ke kanan\n13. Garis horizontal', gifUrl: getGifUrl('kanji', '話') },
            { char: '聞', romaji: 'bun, ki(ku)', meaning: 'Dengar', strokeOrder: '1. Garis vertikal\n2. Garis horizontal\n3. Garis horizontal\n4. Garis vertikal\n5. Garis horizontal\n6. Garis vertikal\n7. Garis miring ke kiri\n8. Garis miring ke kanan\n9. Garis horizontal\n10. Garis vertikal\n11. Garis miring ke kiri\n12. Garis miring ke kanan\n13. Garis horizontal', gifUrl: getGifUrl('kanji', '聞') },
            { char: '書', romaji: 'sho, ka(ku)', meaning: 'Tulis', strokeOrder: '1. Garis vertikal\n2. Garis horizontal\n3. Garis horizontal\n4. Garis vertikal\n5. Garis horizontal\n6. Garis vertikal\n7. Garis miring ke kiri\n8. Garis miring ke kanan\n9. Garis horizontal\n10. Garis vertikal\n11. Garis miring ke kiri\n12. Garis miring ke kanan\n13. Garis horizontal', gifUrl: getGifUrl('kanji', '書') },
            { char: '読', romaji: 'doku, yo(mu)', meaning: 'Baca', strokeOrder: '1. Garis vertikal\n2. Garis horizontal\n3. Garis horizontal\n4. Garis vertikal\n5. Garis horizontal\n6. Garis vertikal\n7. Garis miring ke kiri\n8. Garis miring ke kanan\n9. Garis horizontal\n10. Garis vertikal\n11. Garis miring ke kiri\n12. Garis miring ke kanan\n13. Garis horizontal', gifUrl: getGifUrl('kanji', '読') },
            { char: '見', romaji: 'ken, mi(ru)', meaning: 'Lihat', strokeOrder: '1. Garis vertikal\n2. Garis horizontal\n3. Garis horizontal\n4. Garis vertikal\n5. Garis horizontal\n6. Garis vertikal\n7. Garis miring ke kiri\n8. Garis miring ke kanan\n9. Garis horizontal\n10. Garis vertikal\n11. Garis miring ke kiri\n12. Garis miring ke kanan\n13. Garis horizontal', gifUrl: getGifUrl('kanji', '見') },
            { char: '行', romaji: 'kou, i(ku)', meaning: 'Pergi', strokeOrder: '1. Garis vertikal\n2. Garis horizontal\n3. Garis horizontal\n4. Garis vertikal\n5. Garis horizontal\n6. Garis vertikal\n7. Garis miring ke kiri\n8. Garis miring ke kanan\n9. Garis horizontal\n10. Garis vertikal\n11. Garis miring ke kiri\n12. Garis miring ke kanan\n13. Garis horizontal', gifUrl: getGifUrl('kanji', '行') },
            { char: '来', romaji: 'rai, ku(ru)', meaning: 'Datang', strokeOrder: '1. Garis vertikal\n2. Garis horizontal\n3. Garis horizontal\n4. Garis vertikal\n5. Garis horizontal\n6. Garis vertikal\n7. Garis miring ke kiri\n8. Garis miring ke kanan\n9. Garis horizontal\n10. Garis vertikal\n11. Garis miring ke kiri\n12. Garis miring ke kanan\n13. Garis horizontal', gifUrl: getGifUrl('kanji', '来') },
            { char: '出', romaji: 'shutsu, de(ru)', meaning: 'Keluar', strokeOrder: '1. Garis vertikal\n2. Garis horizontal\n3. Garis horizontal\n4. Garis vertikal\n5. Garis horizontal\n6. Garis vertikal\n7. Garis miring ke kiri\n8. Garis miring ke kanan\n9. Garis horizontal\n10. Garis vertikal\n11. Garis miring ke kiri\n12. Garis miring ke kanan\n13. Garis horizontal', gifUrl: getGifUrl('kanji', '出') },
            { char: '入', romaji: 'nyuu, hai(ru)', meaning: 'Masuk', strokeOrder: '1. Garis vertikal\n2. Garis horizontal\n3. Garis horizontal\n4. Garis vertikal\n5. Garis horizontal\n6. Garis vertikal\n7. Garis miring ke kiri\n8. Garis miring ke kanan\n9. Garis horizontal\n10. Garis vertikal\n11. Garis miring ke kiri\n12. Garis miring ke kanan\n13. Garis horizontal', gifUrl: getGifUrl('kanji', '入') },
            { char: '会', romaji: 'kai, a(u)', meaning: 'Bertemu', strokeOrder: '1. Garis vertikal\n2. Garis horizontal\n3. Garis horizontal\n4. Garis vertikal\n5. Garis horizontal\n6. Garis vertikal\n7. Garis miring ke kiri\n8. Garis miring ke kanan\n9. Garis horizontal\n10. Garis vertikal\n11. Garis miring ke kiri\n12. Garis miring ke kanan\n13. Garis horizontal', gifUrl: getGifUrl('kanji', '会') },
            { char: '社', romaji: 'sha', meaning: 'Perusahaan', strokeOrder: '1. Garis vertikal\n2. Garis horizontal\n3. Garis horizontal\n4. Garis vertikal\n5. Garis horizontal\n6. Garis vertikal\n7. Garis miring ke kiri\n8. Garis miring ke kanan\n9. Garis horizontal\n10. Garis vertikal\n11. Garis miring ke kiri\n12. Garis miring ke kanan\n13. Garis horizontal', gifUrl: getGifUrl('kanji', '社') },
            { char: '員', romaji: 'in', meaning: 'Anggota', strokeOrder: '1. Garis vertikal\n2. Garis horizontal\n3. Garis horizontal\n4. Garis vertikal\n5. Garis horizontal\n6. Garis vertikal\n7. Garis miring ke kiri\n8. Garis miring ke kanan\n9. Garis horizontal\n10. Garis vertikal\n11. Garis miring ke kiri\n12. Garis miring ke kanan\n13. Garis horizontal', gifUrl: getGifUrl('kanji', '員') },
            { char: '店', romaji: 'ten, mise', meaning: 'Toko', strokeOrder: '1. Garis vertikal\n2. Garis horizontal\n3. Garis horizontal\n4. Garis vertikal\n5. Garis horizontal\n6. Garis vertikal\n7. Garis miring ke kiri\n8. Garis miring ke kanan\n9. Garis horizontal\n10. Garis vertikal\n11. Garis miring ke kiri\n12. Garis miring ke kanan\n13. Garis horizontal', gifUrl: getGifUrl('kanji', '店') },
            { char: '駅', romaji: 'eki', meaning: 'Stasiun', strokeOrder: '1. Garis vertikal\n2. Garis horizontal\n3. Garis horizontal\n4. Garis vertikal\n5. Garis horizontal\n6. Garis vertikal\n7. Garis miring ke kiri\n8. Garis miring ke kanan\n9. Garis horizontal\n10. Garis vertikal\n11. Garis miring ke kiri\n12. Garis miring ke kanan\n13. Garis horizontal', gifUrl: getGifUrl('kanji', '駅') },
            { char: '電', romaji: 'den', meaning: 'Listrik', strokeOrder: '1. Garis vertikal\n2. Garis horizontal\n3. Garis horizontal\n4. Garis vertikal\n5. Garis horizontal\n6. Garis vertikal\n7. Garis miring ke kiri\n8. Garis miring ke kanan\n9. Garis horizontal\n10. Garis vertikal\n11. Garis miring ke kiri\n12. Garis miring ke kanan\n13. Garis horizontal', gifUrl: getGifUrl('kanji', '電') },
            { char: '車', romaji: 'sha, kuruma', meaning: 'Mobil', strokeOrder: '1. Garis vertikal\n2. Garis horizontal\n3. Garis horizontal\n4. Garis vertikal\n5. Garis horizontal\n6. Garis vertikal\n7. Garis miring ke kiri\n8. Garis miring ke kanan\n9. Garis horizontal\n10. Garis vertikal\n11. Garis miring ke kiri\n12. Garis miring ke kanan\n13. Garis horizontal', gifUrl: getGifUrl('kanji', '車') },
            { char: '食', romaji: 'shoku, ta(beru)', meaning: 'Makan', strokeOrder: '1. Garis vertikal\n2. Garis horizontal\n3. Garis horizontal\n4. Garis vertikal\n5. Garis horizontal\n6. Garis vertikal\n7. Garis miring ke kiri\n8. Garis miring ke kanan\n9. Garis horizontal\n10. Garis vertikal\n11. Garis miring ke kiri\n12. Garis miring ke kanan\n13. Garis horizontal', gifUrl: getGifUrl('kanji', '食') },
            { char: '飲', romaji: 'in, no(mu)', meaning: 'Minum', strokeOrder: '1. Garis vertikal\n2. Garis horizontal\n3. Garis horizontal\n4. Garis vertikal\n5. Garis horizontal\n6. Garis vertikal\n7. Garis miring ke kiri\n8. Garis miring ke kanan\n9. Garis horizontal\n10. Garis vertikal\n11. Garis miring ke kiri\n12. Garis miring ke kanan\n13. Garis horizontal', gifUrl: getGifUrl('kanji', '飲') },
            { char: '買', romaji: 'bai, ka(u)', meaning: 'Beli', strokeOrder: '1. Garis vertikal\n2. Garis horizontal\n3. Garis horizontal\n4. Garis vertikal\n5. Garis horizontal\n6. Garis vertikal\n7. Garis miring ke kiri\n8. Garis miring ke kanan\n9. Garis horizontal\n10. Garis vertikal\n11. Garis miring ke kiri\n12. Garis miring ke kanan\n13. Garis horizontal', gifUrl: getGifUrl('kanji', '買') },
            { char: '高', romaji: 'kou, taka(i)', meaning: 'Tinggi, Mahal', strokeOrder: '1. Garis vertikal\n2. Garis horizontal\n3. Garis horizontal\n4. Garis vertikal\n5. Garis horizontal\n6. Garis vertikal\n7. Garis miring ke kiri\n8. Garis miring ke kanan\n9. Garis horizontal\n10. Garis vertikal\n11. Garis miring ke kiri\n12. Garis miring ke kanan\n13. Garis horizontal', gifUrl: getGifUrl('kanji', '高') },
            { char: '安', romaji: 'an, yasu(i)', meaning: 'Murah, Tenang', strokeOrder: '1. Garis vertikal\n2. Garis horizontal\n3. Garis horizontal\n4. Garis vertikal\n5. Garis horizontal\n6. Garis vertikal\n7. Garis miring ke kiri\n8. Garis miring ke kanan\n9. Garis horizontal\n10. Garis vertikal\n11. Garis miring ke kiri\n12. Garis miring ke kanan\n13. Garis horizontal', gifUrl: getGifUrl('kanji', '安') },
        ];


        let currentScript = 'hiragana';
        let currentIndex = 0;
        let characters = hiraganaCharacters;

        const canvas = document.getElementById('writingCanvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;

        // Variables for brush effect (speed-based thickness)
        let lastX = 0;
        let lastY = 0;
        let lastTime = 0;
        const minLineWidth = 3; // Minimum line thickness
        const maxLineWidth = 15; // Maximum line thickness
        const maxSpeed = 10; // Max speed (pixels/ms) to influence line width. Adjust as needed.

        // DOM Elements
        const romajiDisplay = document.getElementById('romaji-display'); 
        const meaningDisplay = document.getElementById('meaning-display');
        const strokeOrderText = document.getElementById('stroke-order-text');
        const characterGif = document.getElementById('character-gif');
        const clearBtn = document.getElementById('clear-btn');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const hiraganaBtn = document.getElementById('hiragana-btn');
        const katakanaBtn = document.getElementById('katakana-btn');
        const kanjiBtn = document.getElementById('kanji-btn');
        const progressDisplay = document.getElementById('progress-display'); // New element for progress
        const checkBtn = document.getElementById('check-btn'); // New button
        const feedbackMessage = document.getElementById('feedback-message'); // New div for messages

        // Initialize canvas settings
        ctx.lineCap = 'round';
        ctx.strokeStyle = '#333';
        // Shadow properties for "brush mode" effect
        ctx.shadowBlur = 2; 
        ctx.shadowColor = 'rgba(0, 0, 0, 0.3)'; 
        ctx.shadowOffsetX = 1; 
        ctx.shadowOffsetY = 1; 

        // Function to draw Japanese character on canvas with transparency
        const drawJapaneseCharacterOnCanvas = (char, targetCtx, targetCanvas) => {
            if (!targetCtx || targetCanvas.width === 0 || targetCanvas.height === 0) return; // Ensure canvas is ready

            targetCtx.save(); // Save current canvas state
            targetCtx.clearRect(0, 0, targetCanvas.width, targetCanvas.height); // Clear before drawing sample
            targetCtx.globalAlpha = 0.15; // Set transparency (e.g., 15%)
            targetCtx.font = 'bold ' + (targetCanvas.width * 0.8) + 'px Arial, sans-serif'; // Adjust font size dynamically
            targetCtx.fillStyle = '#d1d5db'; // Set color (light gray)
            targetCtx.textAlign = 'center';
            targetCtx.textBaseline = 'middle';

            // Calculate position to center the text on the canvas
            const x = targetCanvas.width / 2;
            const y = targetCanvas.height / 2;

            targetCtx.fillText(char, x, y);
            targetCtx.restore(); // Restore canvas state (resets globalAlpha, etc.)
        };

        // Function to compare user's drawing with sample
        const checkWriting = () => {
            const currentCharacterData = characters[currentIndex];
            if (!currentCharacterData) {
                feedbackMessage.textContent = 'Tidak ada karakter untuk diperiksa.';
                feedbackMessage.className = 'mt-4 text-red-600 font-semibold';
                return;
            }

            // Create an offscreen canvas to draw the perfect sample character
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            const tempCtx = tempCanvas.getContext('2d');

            // Draw the transparent sample character onto the temporary canvas
            drawJapaneseCharacterOnCanvas(currentCharacterData.char, tempCtx, tempCanvas);

            // Get pixel data from both canvases
            const userImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const sampleImageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);

            const userPixels = userImageData.data;
            const samplePixels = sampleImageData.data;

            let totalSampleOpaquePixels = 0;
            let matchingOpaquePixels = 0;
            const alphaThreshold = 50; // Minimum alpha value to consider a pixel "opaque"

            for (let i = 0; i < samplePixels.length; i += 4) {
                const sampleAlpha = samplePixels[i + 3]; // Alpha channel
                const userAlpha = userPixels[i + 3];

                if (sampleAlpha > alphaThreshold) {
                    totalSampleOpaquePixels++;
                    if (userAlpha > alphaThreshold) {
                        matchingOpaquePixels++;
                    }
                }
            }

            const matchPercentage = totalSampleOpaquePixels > 0 ? (matchingOpaquePixels / totalSampleOpaquePixels) * 100 : 0;

            if (matchPercentage >= 70) { // Threshold for "correct"
                feedbackMessage.textContent = `Bagus sekali! Tulisan Anda ${matchPercentage.toFixed(2)}% cocok.`;
                feedbackMessage.className = 'mt-4 text-green-600 font-semibold';
            } else if (matchPercentage >= 40) {
                feedbackMessage.textContent = `Cukup baik, tapi bisa lebih baik lagi. Kecocokan: ${matchPercentage.toFixed(2)}%.`;
                feedbackMessage.className = 'mt-4 text-orange-600 font-semibold';
            } else {
                feedbackMessage.textContent = `Coba lagi. Tulisan Anda ${matchPercentage.toFixed(2)}% cocok.`;
                feedbackMessage.className = 'mt-4 text-red-600 font-semibold';
            }
        };

        // Function to render the current character data
        const renderCharacter = () => {
            const currentCharacterData = characters[currentIndex];
            if (currentCharacterData) {
                romajiDisplay.textContent = `Romaji: ${currentCharacterData.romaji}`; 
                meaningDisplay.textContent = currentCharacterData.meaning ? `Arti: ${currentCharacterData.meaning}` : '';
                strokeOrderText.textContent = currentCharacterData.strokeOrder;
                characterGif.src = currentCharacterData.gifUrl;
                characterGif.alt = `Stroke order for ${currentCharacterData.char}`;
                // Update progress display
                progressDisplay.textContent = `${currentIndex + 1} / ${characters.length}`;
                // Clear canvas when character changes
                clearCanvas(); // clearCanvas will now also draw the transparent sample
            } else {
                // If no character data, ensure displays are clear
                romajiDisplay.textContent = 'Romaji: N/A'; 
                meaningDisplay.textContent = '';
                strokeOrderText.textContent = 'Tidak ada data urutan goresan.';
                characterGif.src = 'https://placehold.co/150x150/e0e0e0/000000?text=GIF+Tidak+Ada';
                characterGif.alt = 'No GIF available';
                progressDisplay.textContent = '0 / 0';
                clearCanvas(); // Clear canvas even if no character data
            }
            // Clear feedback message on character change
            feedbackMessage.textContent = '';
            feedbackMessage.className = '';
        };

        // Canvas drawing functions
        const getEventPos = (e) => {
            const rect = canvas.getBoundingClientRect();
            if (e.touches && e.touches.length > 0) {
                return {
                    x: e.touches[0].clientX - rect.left,
                    y: e.touches[0].clientY - rect.top
                };
            }
            return {
                x: e.clientX - rect.left,
                y: e.clientY - rect.top
            };
        };

        const startDrawing = (e) => {
            e.preventDefault(); // Prevent scrolling on touch devices
            isDrawing = true;
            const { x, y } = getEventPos(e);
            ctx.beginPath();
            ctx.moveTo(x, y);
            lastX = x;
            lastY = y;
            lastTime = performance.now(); // Get high-resolution time
            ctx.lineWidth = maxLineWidth; // Start with max thickness for the first point
        };

        const draw = (e) => {
            e.preventDefault(); // Prevent scrolling on touch devices
            if (!isDrawing) return;
            const { x, y } = getEventPos(e);
            const currentTime = performance.now();

            // Calculate distance moved
            const dx = x - lastX;
            const dy = y - lastY;
            const distance = Math.sqrt(dx * dx + dy * dy);

            // Calculate time elapsed
            const timeElapsed = currentTime - lastTime;

            let speed = 0;
            if (timeElapsed > 0) { // Avoid division by zero
                speed = distance / timeElapsed;
            }

            // Map speed to line width (slower speed = thicker line)
            // Clamp speed to maxSpeed to prevent extremely thin lines
            const clampedSpeed = Math.min(speed, maxSpeed);
            const normalizedSpeed = clampedSpeed / maxSpeed; // 0 to 1
            
            // Invert the normalized speed: 0 (slow) -> 1 (fast) becomes 1 (slow) -> 0 (fast)
            const invertedNormalizedSpeed = 1 - normalizedSpeed;

            // Map to line width range
            ctx.lineWidth = minLineWidth + (invertedNormalizedSpeed * (maxLineWidth - minLineWidth));
            
            // Ensure line width is within bounds
            ctx.lineWidth = Math.max(minLineWidth, Math.min(ctx.lineWidth, maxLineWidth));


            ctx.lineTo(x, y);
            ctx.stroke();

            lastX = x;
            lastY = y;
            lastTime = currentTime;
        };

        const endDrawing = () => {
            isDrawing = false;
            ctx.closePath();
        };

        const clearCanvas = () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // Redraw transparent Japanese character after clearing
            if (characters[currentIndex]) {
                drawJapaneseCharacterOnCanvas(characters[currentIndex].char, ctx, canvas);
            }
            // Clear feedback message on clear
            feedbackMessage.textContent = '';
            feedbackMessage.className = '';
        };

        // Navigation functions
        const nextCharacter = () => {
            currentIndex = (currentIndex + 1) % characters.length;
            renderCharacter();
        };

        const prevCharacter = () => {
            currentIndex = (currentIndex - 1 + characters.length) % characters.length;
            renderCharacter();
        };

        // Script selection function
        const setScript = (scriptName) => {
            currentScript = scriptName;
            currentIndex = 0; // Reset index when script changes
            hiraganaBtn.classList.remove('bg-blue-600', 'text-white', 'shadow-md');
            hiraganaBtn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-blue-100');
            katakanaBtn.classList.remove('bg-blue-600', 'text-white', 'shadow-md');
            katakanaBtn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-blue-100');
            kanjiBtn.classList.remove('bg-blue-600', 'text-white', 'shadow-md');
            kanjiBtn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-blue-100');

            if (scriptName === 'hiragana') {
                characters = hiraganaCharacters;
                hiraganaBtn.classList.add('bg-blue-600', 'text-white', 'shadow-md');
            } else if (scriptName === 'katakana') {
                characters = katakanaCharacters;
                katakanaBtn.classList.add('bg-blue-600', 'text-white', 'shadow-md');
            } else if (scriptName === 'kanji') {
                characters = kanjiCharacters;
                kanjiBtn.classList.add('bg-blue-600', 'text-white', 'shadow-md');
            }
            renderCharacter();
        };

        // Event Listeners
        window.onload = function() {
            // Set initial canvas size
            const parent = canvas.parentElement;
            canvas.width = parent.clientWidth;
            canvas.height = parent.clientWidth;

            // Canvas drawing event listeners
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', endDrawing);
            canvas.addEventListener('mouseleave', endDrawing); // End drawing if mouse leaves canvas

            canvas.addEventListener('touchstart', startDrawing, { passive: false });
            canvas.addEventListener('touchmove', draw, { passive: false });
            canvas.addEventListener('touchend', endDrawing);

            // Button event listeners
            clearBtn.addEventListener('click', clearCanvas);
            prevBtn.addEventListener('click', prevCharacter);
            nextBtn.addEventListener('click', nextCharacter);
            hiraganaBtn.addEventListener('click', () => setScript('hiragana'));
            katakanaBtn.addEventListener('click', () => setScript('katakana'));
            kanjiBtn.addEventListener('click', () => setScript('kanji'));
            checkBtn.addEventListener('click', checkWriting); // Add event listener for check button

            // Handle window resize for canvas
            window.addEventListener('resize', () => {
                let imageData = null;
                // Only try to get image data if canvas has valid dimensions
                if (canvas.width > 0 && canvas.height > 0) {
                    imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                }

                const parent = canvas.parentElement;
                // Update canvas dimensions first
                canvas.width = parent.clientWidth;
                canvas.height = parent.clientWidth;

                // Restore image data only if it was successfully retrieved
                if (imageData) {
                    ctx.putImageData(imageData, 0, 0);
                } else {
                    // If no image data was saved (e.g., initial load or zero width), clear the canvas
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                }

                // Reapply canvas styles after resize
                ctx.lineCap = 'round';
                ctx.strokeStyle = '#333';
                // Reapply shadow properties after resize
                ctx.shadowBlur = 2;
                ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
                ctx.shadowOffsetX = 1;
                ctx.shadowOffsetY = 1;

                // Redraw transparent Japanese character after resize
                if (characters[currentIndex]) {
                    drawJapaneseCharacterOnCanvas(characters[currentIndex].char, ctx, canvas);
                }
            });

            // Initial render
            setScript('hiragana'); // Start with Hiragana
        };
    </script>
</body>
</html>
